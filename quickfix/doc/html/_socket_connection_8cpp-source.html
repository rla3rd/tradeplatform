<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/home/orenmnero/autobuild/quickfix/src/C++/SocketConnection.cpp Source File</title>
<link href="quickfix.css" rel="stylesheet" type="text/css">
<table cellspacing="0" cellpadding="0" border="0">
  <tr>
   <td><img src="images/outsideTopLeft.gif"></td>
   <td width="100%" class="outsideTop">&nbsp;</td>
   <td><img src="images/outsideTopRight.gif"></td>
  </tr>
  <tr>
   <td class="outsideLeft">&nbsp;</td>
   <td>
	<img src="images/QuickFIX.jpg" align="middle" border=0>
	&nbsp;&nbsp;
	<a href="index.html">Index</a>&nbsp;
	<a href="files.html">Source Files</a>&nbsp;
	<a href="annotated.html">Annotated Class List</a>&nbsp;
	<a href="classes.html">Alphabetical Class List</a>&nbsp;
	<a href="hierarchy.html">Class Hierarchy</a>&nbsp;
	<a href="inherits.html">Graphical Class Hierarchy</a>&nbsp;
   </td>
   <td class="outsideRight">&nbsp;</td>
  </tr>
  <tr>
   <td><img src="images/outsideBottomLeft.gif"></td>
   <td width=100% class="outsideBottom">&nbsp;</td>
   <td><img src="images/outsideBottomRight.gif"></td>
  </tr>
</table>
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.3.6-20040222 -->
<h1>/home/orenmnero/autobuild/quickfix/src/C++/SocketConnection.cpp</h1><a href="_socket_connection_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">** Copyright (c) quickfixengine.org  All rights reserved.</span>
00003 <span class="comment">**</span>
00004 <span class="comment">** This file is part of the QuickFIX FIX Engine</span>
00005 <span class="comment">**</span>
00006 <span class="comment">** This file may be distributed under the terms of the quickfixengine.org</span>
00007 <span class="comment">** license as defined by quickfixengine.org and appearing in the file</span>
00008 <span class="comment">** LICENSE included in the packaging of this file.</span>
00009 <span class="comment">**</span>
00010 <span class="comment">** This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE</span>
00011 <span class="comment">** WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
00012 <span class="comment">**</span>
00013 <span class="comment">** See http://www.quickfixengine.org/LICENSE for licensing information.</span>
00014 <span class="comment">**</span>
00015 <span class="comment">** Contact ask@quickfixengine.org if any conditions of this licensing are</span>
00016 <span class="comment">** not clear to you.</span>
00017 <span class="comment">**</span>
00018 <span class="comment">****************************************************************************/</span>
00019 
00020 <span class="preprocessor">#ifdef _MSC_VER</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#include "stdafx.h"</span>
00022 <span class="preprocessor">#else</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00024 <span class="preprocessor">#endif</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="_call_stack_8h.html">CallStack.h</a>"</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="_socket_connection_8h.html">SocketConnection.h</a>"</span>
00028 <span class="preprocessor">#include "<a class="code" href="_socket_acceptor_8h.html">SocketAcceptor.h</a>"</span>
00029 <span class="preprocessor">#include "<a class="code" href="_socket_connector_8h.html">SocketConnector.h</a>"</span>
00030 <span class="preprocessor">#include "<a class="code" href="_socket_initiator_8h.html">SocketInitiator.h</a>"</span>
00031 <span class="preprocessor">#include "<a class="code" href="_session_8h.html">Session.h</a>"</span>
00032 <span class="preprocessor">#include "<a class="code" href="_utility_8h.html">Utility.h</a>"</span>
00033 
00034 <span class="keyword">namespace </span>FIX
00035 {
<a name="l00036"></a><a class="code" href="class_f_i_x_1_1_socket_connection.html#a0">00036</a> SocketConnection::SocketConnection( <span class="keywordtype">int</span> s, Sessions sessions,
00037                                     <a class="code" href="class_f_i_x_1_1_socket_monitor.html">SocketMonitor</a>* pMonitor )
00038 : m_socket( s ), m_sendLength( 0 ),
00039   m_sessions(sessions), m_pSession( 0 ), m_pMonitor( pMonitor )
00040 {
00041   FD_ZERO( &amp;m_fds );
00042   FD_SET( m_socket, &amp;m_fds );
00043 }
00044 
<a name="l00045"></a><a class="code" href="class_f_i_x_1_1_socket_connection.html#a1">00045</a> SocketConnection::SocketConnection( <a class="code" href="class_f_i_x_1_1_socket_initiator.html">SocketInitiator</a>&amp; i,
00046                                     <span class="keyword">const</span> <a class="code" href="class_f_i_x_1_1_session_i_d.html">SessionID</a>&amp; sessionID, <span class="keywordtype">int</span> s,
00047                                     <a class="code" href="class_f_i_x_1_1_socket_monitor.html">SocketMonitor</a>* pMonitor )
00048 : m_socket( s ), m_sendLength( 0 ),
00049   m_pSession( i.getSession( sessionID, *this ) ),
00050   m_pMonitor( pMonitor ) 
00051 {
00052   FD_ZERO( &amp;m_fds );
00053   FD_SET( m_socket, &amp;m_fds );
00054   m_sessions.insert( sessionID );
00055 }
00056 
<a name="l00057"></a><a class="code" href="class_f_i_x_1_1_socket_connection.html#a2">00057</a> SocketConnection::~SocketConnection()
00058 {
00059   <span class="keywordflow">if</span> ( <a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a> )
00060     Session::unregisterSession( <a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a>-&gt;<a class="code" href="class_f_i_x_1_1_session.html#a13">getSessionID</a>() );
00061 }
00062 
<a name="l00063"></a><a class="code" href="class_f_i_x_1_1_socket_connection.html#d4">00063</a> <span class="keywordtype">bool</span> SocketConnection::send( <span class="keyword">const</span> std::string&amp; msg )
00064 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketConnection::send)
00065 
00066   <a class="code" href="class_f_i_x_1_1_locker.html">Locker</a> l( m_mutex );
00067 
00068   <a class="code" href="class_f_i_x_1_1_socket_connection.html#r3">m_sendQueue</a>.push_back( msg );
00069   <a class="code" href="class_f_i_x_1_1_socket_connection.html#a7">processQueue</a>();
00070   <a class="code" href="class_f_i_x_1_1_socket_connection.html#a8">signal</a>();
00071   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00072 
00073   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00074 }
00075 
<a name="l00076"></a><a class="code" href="class_f_i_x_1_1_socket_connection.html#a7">00076</a> <span class="keywordtype">bool</span> SocketConnection::processQueue()
00077 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketConnection::processQueue)
00078 
00079   <a class="code" href="class_f_i_x_1_1_locker.html">Locker</a> l( m_mutex );
00080 
00081   <span class="keywordflow">if</span>( !<a class="code" href="class_f_i_x_1_1_socket_connection.html#r3">m_sendQueue</a>.size() ) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00082 
00083   <span class="keyword">struct </span>timeval timeout = { 0, 0 };
00084   fd_set writeset = m_fds;
00085   <span class="keywordflow">if</span>( select( 1 + m_socket, 0, &amp;writeset, 0, &amp;timeout ) &lt;= 0 )
00086     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00087     
00088   <span class="keyword">const</span> std::string&amp; msg = <a class="code" href="class_f_i_x_1_1_socket_connection.html#r3">m_sendQueue</a>.front();
00089 
00090   <span class="keywordtype">int</span> result = <a class="code" href="namespace_f_i_x.html#a2919">socket_send</a>
00091     ( m_socket, msg.c_str() + <a class="code" href="class_f_i_x_1_1_socket_connection.html#r4">m_sendLength</a>, msg.length() - <a class="code" href="class_f_i_x_1_1_socket_connection.html#r4">m_sendLength</a> );
00092 
00093   <span class="keywordflow">if</span>( result &gt; 0 )
00094     <a class="code" href="class_f_i_x_1_1_socket_connection.html#r4">m_sendLength</a> += result;
00095 
00096   <span class="keywordflow">if</span>( <a class="code" href="class_f_i_x_1_1_socket_connection.html#r4">m_sendLength</a> == msg.length() )
00097   {
00098     <a class="code" href="class_f_i_x_1_1_socket_connection.html#r4">m_sendLength</a> = 0;
00099     <a class="code" href="class_f_i_x_1_1_socket_connection.html#r3">m_sendQueue</a>.pop_front();
00100   }
00101 
00102   <span class="keywordflow">return</span> !<a class="code" href="class_f_i_x_1_1_socket_connection.html#r3">m_sendQueue</a>.size();
00103 
00104   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00105 }
00106 
<a name="l00107"></a><a class="code" href="class_f_i_x_1_1_socket_connection.html#d5">00107</a> <span class="keywordtype">void</span> SocketConnection::disconnect()
00108 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketConnection::disconnect)
00109 
00110   <span class="keywordflow">if</span> ( <a class="code" href="class_f_i_x_1_1_socket_connection.html#r7">m_pMonitor</a> )
00111     <a class="code" href="class_f_i_x_1_1_socket_connection.html#r7">m_pMonitor</a>-&gt;<a class="code" href="class_f_i_x_1_1_socket_monitor.html#a5">drop</a>( m_socket );
00112 
00113   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00114 }
00115 
<a name="l00116"></a><a class="code" href="class_f_i_x_1_1_socket_connection.html#a5">00116</a> <span class="keywordtype">bool</span> SocketConnection::read( <a class="code" href="class_f_i_x_1_1_socket_connector.html">SocketConnector</a>&amp; s )
00117 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketConnection::read)
00118 
00119   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a> ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00120 
00121   <span class="keywordflow">try</span>
00122   {
00123     <a class="code" href="class_f_i_x_1_1_socket_connection.html#d1">readFromSocket</a>();
00124     <a class="code" href="class_f_i_x_1_1_socket_connection.html#d3">readMessages</a>( s.<a class="code" href="class_f_i_x_1_1_socket_connector.html#a4">getMonitor</a>() );
00125   }
00126   <span class="keywordflow">catch</span>( <a class="code" href="struct_f_i_x_1_1_socket_recv_failed.html">SocketRecvFailed</a>&amp; e )
00127   {
00128     <a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a>-&gt;<a class="code" href="class_f_i_x_1_1_session.html#a51">getLog</a>()-&gt;<a class="code" href="class_f_i_x_1_1_log.html#a4">onEvent</a>( e.what() );
00129     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00130   }
00131   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00132 
00133   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00134 }
00135 
<a name="l00136"></a><a class="code" href="class_f_i_x_1_1_socket_connection.html#a6">00136</a> <span class="keywordtype">bool</span> SocketConnection::read( <a class="code" href="class_f_i_x_1_1_socket_acceptor.html">SocketAcceptor</a>&amp; a, <a class="code" href="class_f_i_x_1_1_socket_server.html">SocketServer</a>&amp; s )
00137 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketConnection::read)
00138 
00139   std::string msg;
00140   <span class="keywordflow">try</span>
00141   {
00142     <a class="code" href="class_f_i_x_1_1_socket_connection.html#d1">readFromSocket</a>();
00143 
00144     <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a> )
00145     {
00146       <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_socket_connection.html#d2">readMessage</a>( msg ) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00147       <a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a> = Session::lookupSession( msg, <span class="keyword">true</span> );
00148       <span class="keywordflow">if</span>( !<a class="code" href="class_f_i_x_1_1_socket_connection.html#d0">isValidSession</a>() )
00149       {
00150         <a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a> = 0;
00151         a.<a class="code" href="class_f_i_x_1_1_acceptor.html#a14">onEvent</a>( <span class="stringliteral">"Session not found for incoming message: "</span> + msg );
00152         a.<a class="code" href="class_f_i_x_1_1_acceptor.html#a15">onIncoming</a>( msg );
00153       }
00154       <span class="keywordflow">if</span>( <a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a> )
00155         <a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a> = a.<a class="code" href="class_f_i_x_1_1_acceptor.html#a8">getSession</a>( msg, *<span class="keyword">this</span> );
00156       <span class="keywordflow">if</span>( <a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a> )
00157         <a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a>-&gt;<a class="code" href="class_f_i_x_1_1_session.html#a45">next</a>( msg );
00158       <span class="keywordflow">if</span>( !<a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a> )
00159       {
00160         s.<a class="code" href="class_f_i_x_1_1_socket_server.html#a6">getMonitor</a>().<a class="code" href="class_f_i_x_1_1_socket_monitor.html#a5">drop</a>( m_socket );
00161         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00162       }
00163 
00164       Session::registerSession( <a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a>-&gt;<a class="code" href="class_f_i_x_1_1_session.html#a13">getSessionID</a>() );
00165     }
00166 
00167     <a class="code" href="class_f_i_x_1_1_socket_connection.html#d3">readMessages</a>( s.<a class="code" href="class_f_i_x_1_1_socket_server.html#a6">getMonitor</a>() );
00168     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00169   }
00170   <span class="keywordflow">catch</span> ( <a class="code" href="struct_f_i_x_1_1_socket_recv_failed.html">SocketRecvFailed</a>&amp; e )
00171   {
00172     <span class="keywordflow">if</span>( <a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a> )
00173       <a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a>-&gt;<a class="code" href="class_f_i_x_1_1_session.html#a51">getLog</a>()-&gt;<a class="code" href="class_f_i_x_1_1_log.html#a4">onEvent</a>( e.what() );
00174     s.<a class="code" href="class_f_i_x_1_1_socket_server.html#a6">getMonitor</a>().<a class="code" href="class_f_i_x_1_1_socket_monitor.html#a5">drop</a>( m_socket );
00175   }
00176   <span class="keywordflow">catch</span> ( <a class="code" href="struct_f_i_x_1_1_invalid_message.html">InvalidMessage</a>&amp; )
00177   {
00178     s.<a class="code" href="class_f_i_x_1_1_socket_server.html#a6">getMonitor</a>().<a class="code" href="class_f_i_x_1_1_socket_monitor.html#a5">drop</a>( m_socket );
00179   }
00180   <span class="keywordflow">return</span> <span class="keyword">false</span>;
00181 
00182   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00183 }
00184 
<a name="l00185"></a><a class="code" href="class_f_i_x_1_1_socket_connection.html#d0">00185</a> <span class="keywordtype">bool</span> SocketConnection::isValidSession()
00186 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketConnection::isValidSession)
00187 
00188   <span class="keywordflow">if</span>( <a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a> == 0 )
00189     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00190   <a class="code" href="class_f_i_x_1_1_session_i_d.html">SessionID</a> sessionID = <a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a>-&gt;<a class="code" href="class_f_i_x_1_1_session.html#a13">getSessionID</a>();
00191   <span class="keywordflow">if</span>( Session::isSessionRegistered(sessionID) )
00192     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00193   <span class="keywordflow">return</span> !( m_sessions.find(sessionID) == m_sessions.end() );
00194 
00195   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00196 }
00197 
<a name="l00198"></a><a class="code" href="class_f_i_x_1_1_socket_connection.html#d1">00198</a> <span class="keywordtype">void</span> SocketConnection::readFromSocket()
00199 <span class="keywordflow">throw</span>( <a class="code" href="struct_f_i_x_1_1_socket_recv_failed.html">SocketRecvFailed</a> )
00200 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketConnection::readFromSocket)
00201 
00202   <span class="keywordtype">int</span> size = recv( m_socket, m_buffer, <span class="keyword">sizeof</span>(m_buffer), 0 );
00203   <span class="keywordflow">if</span>( size &lt;= 0 ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_socket_recv_failed.html">SocketRecvFailed</a>( size );
00204   m_parser.addToStream( m_buffer, size );
00205 
00206   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00207 }
00208 
<a name="l00209"></a><a class="code" href="class_f_i_x_1_1_socket_connection.html#d2">00209</a> <span class="keywordtype">bool</span> SocketConnection::readMessage( std::string&amp; msg )
00210 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketConnection::readMessage)
00211 
00212   <span class="keywordflow">try</span>
00213   {
00214     <span class="keywordflow">return</span> m_parser.<a class="code" href="class_f_i_x_1_1_parser.html#a3">readFixMessage</a>( msg );
00215   }
00216   <span class="keywordflow">catch</span> ( <a class="code" href="struct_f_i_x_1_1_message_parse_error.html">MessageParseError</a>&amp; ) {}
00217   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00218 
00219   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00220 }
00221 
<a name="l00222"></a><a class="code" href="class_f_i_x_1_1_socket_connection.html#d3">00222</a> <span class="keywordtype">void</span> SocketConnection::readMessages( <a class="code" href="class_f_i_x_1_1_socket_monitor.html">SocketMonitor</a>&amp; s )
00223 {
00224   <span class="keywordflow">if</span>( !<a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a> ) <span class="keywordflow">return</span>;
00225 
00226   std::string msg;
00227   <span class="keywordflow">while</span>( <a class="code" href="class_f_i_x_1_1_socket_connection.html#d2">readMessage</a>( msg ) )
00228   {
00229     <span class="keywordflow">try</span>
00230     {
00231       <a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a>-&gt;<a class="code" href="class_f_i_x_1_1_session.html#a45">next</a>( msg );
00232     }
00233     <span class="keywordflow">catch</span> ( <a class="code" href="struct_f_i_x_1_1_invalid_message.html">InvalidMessage</a>&amp; )
00234     {
00235       <span class="keywordflow">if</span>( !<a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a>-&gt;<a class="code" href="class_f_i_x_1_1_session.html#a8">isLoggedOn</a>() )
00236         s.<a class="code" href="class_f_i_x_1_1_socket_monitor.html#a5">drop</a>( m_socket );
00237     }
00238   }
00239 }
00240 
<a name="l00241"></a><a class="code" href="class_f_i_x_1_1_socket_connection.html#a10">00241</a> <span class="keywordtype">void</span> SocketConnection::onTimeout()
00242 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketConnection::onTimeout)
00243   <span class="keywordflow">if</span> ( <a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a> ) <a class="code" href="class_f_i_x_1_1_socket_connection.html#r6">m_pSession</a>-&gt;<a class="code" href="class_f_i_x_1_1_session.html#a45">next</a>();
00244   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00245 }
00246 } <span class="comment">// namespace FIX</span>
</pre></div><hr><address><small>
Generated on Thu Sep 14 08:52:36 2006 for QuickFIX by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.6-20040222 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
