<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/home/orenmnero/autobuild/quickfix/src/C++/SocketServer.cpp Source File</title>
<link href="quickfix.css" rel="stylesheet" type="text/css">
<table cellspacing="0" cellpadding="0" border="0">
  <tr>
   <td><img src="images/outsideTopLeft.gif"></td>
   <td width="100%" class="outsideTop">&nbsp;</td>
   <td><img src="images/outsideTopRight.gif"></td>
  </tr>
  <tr>
   <td class="outsideLeft">&nbsp;</td>
   <td>
	<img src="images/QuickFIX.jpg" align="middle" border=0>
	&nbsp;&nbsp;
	<a href="index.html">Index</a>&nbsp;
	<a href="files.html">Source Files</a>&nbsp;
	<a href="annotated.html">Annotated Class List</a>&nbsp;
	<a href="classes.html">Alphabetical Class List</a>&nbsp;
	<a href="hierarchy.html">Class Hierarchy</a>&nbsp;
	<a href="inherits.html">Graphical Class Hierarchy</a>&nbsp;
   </td>
   <td class="outsideRight">&nbsp;</td>
  </tr>
  <tr>
   <td><img src="images/outsideBottomLeft.gif"></td>
   <td width=100% class="outsideBottom">&nbsp;</td>
   <td><img src="images/outsideBottomRight.gif"></td>
  </tr>
</table>
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.3.6-20040222 -->
<h1>/home/orenmnero/autobuild/quickfix/src/C++/SocketServer.cpp</h1><a href="_socket_server_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">** Copyright (c) quickfixengine.org  All rights reserved.</span>
00003 <span class="comment">**</span>
00004 <span class="comment">** This file is part of the QuickFIX FIX Engine</span>
00005 <span class="comment">**</span>
00006 <span class="comment">** This file may be distributed under the terms of the quickfixengine.org</span>
00007 <span class="comment">** license as defined by quickfixengine.org and appearing in the file</span>
00008 <span class="comment">** LICENSE included in the packaging of this file.</span>
00009 <span class="comment">**</span>
00010 <span class="comment">** This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE</span>
00011 <span class="comment">** WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
00012 <span class="comment">**</span>
00013 <span class="comment">** See http://www.quickfixengine.org/LICENSE for licensing information.</span>
00014 <span class="comment">**</span>
00015 <span class="comment">** Contact ask@quickfixengine.org if any conditions of this licensing are</span>
00016 <span class="comment">** not clear to you.</span>
00017 <span class="comment">**</span>
00018 <span class="comment">****************************************************************************/</span>
00019 
00020 <span class="preprocessor">#ifdef _MSC_VER</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#include "stdafx.h"</span>
00022 <span class="preprocessor">#else</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00024 <span class="preprocessor">#endif</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="_call_stack_8h.html">CallStack.h</a>"</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="_socket_server_8h.html">SocketServer.h</a>"</span>
00028 <span class="preprocessor">#include "<a class="code" href="_utility_8h.html">Utility.h</a>"</span>
00029 <span class="preprocessor">#include "<a class="code" href="_exceptions_8h.html">Exceptions.h</a>"</span>
00030 <span class="preprocessor">#ifndef _MSC_VER</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#include &lt;unistd.h&gt;</span>
00032 <span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span>
00033 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00034 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00035 <span class="preprocessor">#endif</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#include &lt;exception&gt;</span>
00037 
00038 <span class="keyword">namespace </span>FIX
00039 {
<a name="l00041"></a><a class="code" href="class_f_i_x_1_1_server_wrapper.html">00041</a> <span class="keyword">class </span><a class="code" href="class_f_i_x_1_1_server_wrapper.html">ServerWrapper</a> : <span class="keyword">public</span> <a class="code" href="class_f_i_x_1_1_socket_monitor.html">SocketMonitor</a>::Strategy
00042 {
00043 <span class="keyword">public</span>:
<a name="l00044"></a><a class="code" href="class_f_i_x_1_1_server_wrapper.html#a0">00044</a>   <a class="code" href="class_f_i_x_1_1_server_wrapper.html#a0">ServerWrapper</a>( std::set&lt;int&gt; sockets, <a class="code" href="class_f_i_x_1_1_socket_server.html">SocketServer</a>&amp; server,
00045                  <a class="code" href="class_f_i_x_1_1_socket_server_1_1_strategy.html">SocketServer::Strategy</a>&amp; strategy )
00046 : <a class="code" href="class_f_i_x_1_1_server_wrapper.html#r0">m_sockets</a>( sockets ), <a class="code" href="class_f_i_x_1_1_server_wrapper.html#r1">m_server</a>( server ), m_strategy( strategy ) {}
00047 
00048 <span class="keyword">private</span>:
<a name="l00049"></a><a class="code" href="class_f_i_x_1_1_server_wrapper.html#d0">00049</a>   <span class="keywordtype">void</span> <a class="code" href="class_f_i_x_1_1_server_wrapper.html#d0">onConnect</a>( <a class="code" href="class_f_i_x_1_1_socket_monitor.html">SocketMonitor</a>&amp;, <span class="keywordtype">int</span> socket )
00050   { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(ServerWrapper::onConnect)
00051     <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00052   }
00053 
<a name="l00054"></a><a class="code" href="class_f_i_x_1_1_server_wrapper.html#d1">00054</a>   <span class="keywordtype">void</span> <a class="code" href="class_f_i_x_1_1_server_wrapper.html#d1">onEvent</a>( <a class="code" href="class_f_i_x_1_1_socket_monitor.html">SocketMonitor</a>&amp; monitor, <span class="keywordtype">int</span> socket )
00055   { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(ServerWrapper::onEvent)
00056 
00057     <span class="keywordflow">if</span>( <a class="code" href="class_f_i_x_1_1_server_wrapper.html#r0">m_sockets</a>.find(socket) != <a class="code" href="class_f_i_x_1_1_server_wrapper.html#r0">m_sockets</a>.end() )
00058     {
00059       m_strategy.<a class="code" href="class_f_i_x_1_1_socket_server_1_1_strategy.html#a1">onConnect</a>( <a class="code" href="class_f_i_x_1_1_server_wrapper.html#r1">m_server</a>, socket, <a class="code" href="class_f_i_x_1_1_server_wrapper.html#r1">m_server</a>.<a class="code" href="class_f_i_x_1_1_socket_server.html#a2">accept</a>(socket) );
00060     }
00061     <span class="keywordflow">else</span>
00062     {
00063       <span class="keywordflow">if</span>( !m_strategy.<a class="code" href="class_f_i_x_1_1_socket_server_1_1_strategy.html#a3">onData</a>( <a class="code" href="class_f_i_x_1_1_server_wrapper.html#r1">m_server</a>, socket ) )
00064         <a class="code" href="class_f_i_x_1_1_server_wrapper.html#d3">onError</a>( monitor, socket );
00065     }
00066 
00067     <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00068   }
00069 
<a name="l00070"></a><a class="code" href="class_f_i_x_1_1_server_wrapper.html#d2">00070</a>   <span class="keywordtype">void</span> <a class="code" href="class_f_i_x_1_1_server_wrapper.html#d2">onWrite</a>( <a class="code" href="class_f_i_x_1_1_socket_monitor.html">SocketMonitor</a>&amp;, <span class="keywordtype">int</span> socket )
00071   { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(ServerWrapper::onWrite)
00072 
00073     m_strategy.<a class="code" href="class_f_i_x_1_1_socket_server_1_1_strategy.html#a2">onWrite</a>( <a class="code" href="class_f_i_x_1_1_server_wrapper.html#r1">m_server</a>, socket );
00074 
00075     <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00076   }
00077 
<a name="l00078"></a><a class="code" href="class_f_i_x_1_1_server_wrapper.html#d3">00078</a>   <span class="keywordtype">void</span> <a class="code" href="class_f_i_x_1_1_server_wrapper.html#d3">onError</a>( <a class="code" href="class_f_i_x_1_1_socket_monitor.html">SocketMonitor</a>&amp; monitor, <span class="keywordtype">int</span> socket )
00079   { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(ServerWrapper::onError)
00080 
00081     m_strategy.<a class="code" href="class_f_i_x_1_1_socket_server_1_1_strategy.html#a4">onDisconnect</a>( <a class="code" href="class_f_i_x_1_1_server_wrapper.html#r1">m_server</a>, socket );
00082     monitor.<a class="code" href="class_f_i_x_1_1_socket_monitor.html#a5">drop</a>( socket );
00083 
00084     <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00085   }
00086 
<a name="l00087"></a><a class="code" href="class_f_i_x_1_1_server_wrapper.html#d4">00087</a>   <span class="keywordtype">void</span> <a class="code" href="class_f_i_x_1_1_server_wrapper.html#d3">onError</a>( <a class="code" href="class_f_i_x_1_1_socket_monitor.html">SocketMonitor</a>&amp; )
00088   { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(ServerWrapper::onError)
00089     m_strategy.<a class="code" href="class_f_i_x_1_1_socket_server_1_1_strategy.html#a5">onError</a>( <a class="code" href="class_f_i_x_1_1_server_wrapper.html#r1">m_server</a> );
00090     <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00091   }
00092 
<a name="l00093"></a><a class="code" href="class_f_i_x_1_1_server_wrapper.html#d5">00093</a>   <span class="keywordtype">void</span> <a class="code" href="class_f_i_x_1_1_server_wrapper.html#d5">onTimeout</a>( <a class="code" href="class_f_i_x_1_1_socket_monitor.html">SocketMonitor</a>&amp; )
00094   { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(ServerWrapper::onTimeout)
00095     m_strategy.<a class="code" href="class_f_i_x_1_1_socket_server_1_1_strategy.html#a6">onTimeout</a>( <a class="code" href="class_f_i_x_1_1_server_wrapper.html#r1">m_server</a> );
00096     <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00097   };
00098 
00099   <span class="keyword">typedef</span> std::set&lt;int&gt;
<a name="l00100"></a><a class="code" href="class_f_i_x_1_1_server_wrapper.html#y0">00100</a>     Sockets;
00101 
<a name="l00102"></a><a class="code" href="class_f_i_x_1_1_server_wrapper.html#r0">00102</a>   Sockets <a class="code" href="class_f_i_x_1_1_server_wrapper.html#r0">m_sockets</a>;
<a name="l00103"></a><a class="code" href="class_f_i_x_1_1_server_wrapper.html#r1">00103</a>   <a class="code" href="class_f_i_x_1_1_socket_server.html">SocketServer</a>&amp; <a class="code" href="class_f_i_x_1_1_server_wrapper.html#r1">m_server</a>;
<a name="l00104"></a><a class="code" href="class_f_i_x_1_1_server_wrapper.html#r2">00104</a>   <a class="code" href="class_f_i_x_1_1_socket_server_1_1_strategy.html">SocketServer::Strategy</a>&amp; m_strategy;
00105 };
00106 
<a name="l00107"></a><a class="code" href="class_f_i_x_1_1_socket_server.html#a0">00107</a> SocketServer::SocketServer( <span class="keywordtype">int</span> timeout )
00108 : m_monitor( timeout ) {}
00109 
<a name="l00110"></a><a class="code" href="class_f_i_x_1_1_socket_server.html#a1">00110</a> <span class="keywordtype">int</span> SocketServer::add( <span class="keywordtype">int</span> port, <span class="keywordtype">bool</span> reuse, <span class="keywordtype">bool</span> noDelay )
00111   <span class="keywordflow">throw</span>( <a class="code" href="struct_f_i_x_1_1_socket_exception.html">SocketException</a>&amp; )
00112 {
00113   <span class="keywordflow">if</span>( m_portToInfo.find(port) != m_portToInfo.end() )
00114     <span class="keywordflow">return</span> m_portToInfo[port].m_socket;
00115 
00116   <span class="keywordtype">int</span> socket = <a class="code" href="namespace_f_i_x.html#a2915">socket_createAcceptor</a>( port, reuse );
00117   <span class="keywordflow">if</span>( socket &lt; 0 )
00118     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_socket_exception.html">SocketException</a>();
00119   <span class="keywordflow">if</span>( noDelay )
00120     <a class="code" href="namespace_f_i_x.html#a2923">socket_setsockopt</a>( socket, TCP_NODELAY );
00121   m_monitor.addRead( socket );
00122 
00123   <a class="code" href="struct_f_i_x_1_1_socket_info.html">SocketInfo</a> info( socket, port, noDelay );
00124   m_socketToInfo[socket] = info;
00125   m_portToInfo[port] = info;
00126   <span class="keywordflow">return</span> socket;
00127 }
00128 
<a name="l00129"></a><a class="code" href="class_f_i_x_1_1_socket_server.html#a2">00129</a> <span class="keywordtype">int</span> SocketServer::accept( <span class="keywordtype">int</span> socket )
00130 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketServer::accept)
00131 
00132   <a class="code" href="struct_f_i_x_1_1_socket_info.html">SocketInfo</a> info = <a class="code" href="class_f_i_x_1_1_socket_server.html#r0">m_socketToInfo</a>[socket];
00133 
00134   <span class="keywordtype">int</span> result = <a class="code" href="namespace_f_i_x.html#a2918">socket_accept</a>( socket );
00135   <span class="keywordflow">if</span>( info.<a class="code" href="struct_f_i_x_1_1_socket_info.html#o2">m_noDelay</a> )
00136     <a class="code" href="namespace_f_i_x.html#a2923">socket_setsockopt</a>( result, TCP_NODELAY );
00137   <span class="keywordflow">if</span> ( result &gt;= 0 )
00138     m_monitor.<a class="code" href="class_f_i_x_1_1_socket_monitor.html#a2">addConnect</a>( result );
00139   <span class="keywordflow">return</span> result;
00140 
00141   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00142 }
00143 
<a name="l00144"></a><a class="code" href="class_f_i_x_1_1_socket_server.html#a3">00144</a> <span class="keywordtype">void</span> SocketServer::close()
00145 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketServer::close)
00146 
00147   SocketToInfo::iterator i = <a class="code" href="class_f_i_x_1_1_socket_server.html#r0">m_socketToInfo</a>.begin();
00148   <span class="keywordflow">for</span>( ; i != <a class="code" href="class_f_i_x_1_1_socket_server.html#r0">m_socketToInfo</a>.end(); ++i )
00149   {
00150     <span class="keywordtype">int</span> s = i-&gt;first;
00151     <a class="code" href="namespace_f_i_x.html#a2920">socket_close</a>( s );
00152     <a class="code" href="namespace_f_i_x.html#a2931">socket_invalidate</a>( s );
00153   }
00154 
00155   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00156 }
00157 
<a name="l00158"></a><a class="code" href="class_f_i_x_1_1_socket_server.html#a4">00158</a> <span class="keywordtype">bool</span> SocketServer::block( <a class="code" href="class_f_i_x_1_1_socket_server_1_1_strategy.html">Strategy</a>&amp; strategy, <span class="keywordtype">bool</span> poll )
00159 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketServer::block)
00160 
00161   std::set&lt;int&gt; sockets;
00162   SocketToInfo::iterator i = <a class="code" href="class_f_i_x_1_1_socket_server.html#r0">m_socketToInfo</a>.begin();
00163   <span class="keywordflow">for</span>( ; i != <a class="code" href="class_f_i_x_1_1_socket_server.html#r0">m_socketToInfo</a>.end(); ++i )
00164   {
00165     <span class="keywordflow">if</span>( !<a class="code" href="namespace_f_i_x.html#a2929">socket_isValid</a>(i-&gt;first) )
00166       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00167     sockets.insert( i-&gt;first );
00168   }
00169 
00170   <a class="code" href="class_f_i_x_1_1_server_wrapper.html">ServerWrapper</a> wrapper( sockets, *<span class="keyword">this</span>, strategy );
00171   m_monitor.<a class="code" href="class_f_i_x_1_1_socket_monitor.html#a8">block</a>( wrapper, poll );
00172   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00173 
00174   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00175 }
00176 
<a name="l00177"></a><a class="code" href="class_f_i_x_1_1_socket_server.html#a7">00177</a> <span class="keywordtype">int</span> SocketServer::socketToPort( <span class="keywordtype">int</span> socket )
00178 {
00179   SocketToInfo::iterator find = <a class="code" href="class_f_i_x_1_1_socket_server.html#r0">m_socketToInfo</a>.find( socket );
00180   <span class="keywordflow">if</span>( find == <a class="code" href="class_f_i_x_1_1_socket_server.html#r0">m_socketToInfo</a>.end() ) <span class="keywordflow">return</span> 0;
00181   <span class="keywordflow">return</span> find-&gt;second.m_port;
00182 }
00183  
<a name="l00184"></a><a class="code" href="class_f_i_x_1_1_socket_server.html#a8">00184</a> <span class="keywordtype">int</span> SocketServer::portToSocket( <span class="keywordtype">int</span> port )
00185 {
00186   SocketToInfo::iterator find = <a class="code" href="class_f_i_x_1_1_socket_server.html#r1">m_portToInfo</a>.find( port );
00187   <span class="keywordflow">if</span>( find == <a class="code" href="class_f_i_x_1_1_socket_server.html#r1">m_portToInfo</a>.end() ) <span class="keywordflow">return</span> 0;
00188   <span class="keywordflow">return</span> find-&gt;second.m_socket;
00189 }
00190 }
</pre></div><hr><address><small>
Generated on Thu Sep 14 08:52:37 2006 for QuickFIX by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.6-20040222 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
