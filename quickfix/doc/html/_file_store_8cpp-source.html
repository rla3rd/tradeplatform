<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/home/orenmnero/autobuild/quickfix/src/C++/FileStore.cpp Source File</title>
<link href="quickfix.css" rel="stylesheet" type="text/css">
<table cellspacing="0" cellpadding="0" border="0">
  <tr>
   <td><img src="images/outsideTopLeft.gif"></td>
   <td width="100%" class="outsideTop">&nbsp;</td>
   <td><img src="images/outsideTopRight.gif"></td>
  </tr>
  <tr>
   <td class="outsideLeft">&nbsp;</td>
   <td>
	<img src="images/QuickFIX.jpg" align="middle" border=0>
	&nbsp;&nbsp;
	<a href="index.html">Index</a>&nbsp;
	<a href="files.html">Source Files</a>&nbsp;
	<a href="annotated.html">Annotated Class List</a>&nbsp;
	<a href="classes.html">Alphabetical Class List</a>&nbsp;
	<a href="hierarchy.html">Class Hierarchy</a>&nbsp;
	<a href="inherits.html">Graphical Class Hierarchy</a>&nbsp;
   </td>
   <td class="outsideRight">&nbsp;</td>
  </tr>
  <tr>
   <td><img src="images/outsideBottomLeft.gif"></td>
   <td width=100% class="outsideBottom">&nbsp;</td>
   <td><img src="images/outsideBottomRight.gif"></td>
  </tr>
</table>
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.3.6-20040222 -->
<h1>/home/orenmnero/autobuild/quickfix/src/C++/FileStore.cpp</h1><a href="_file_store_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">** Copyright (c) quickfixengine.org  All rights reserved.</span>
00003 <span class="comment">**</span>
00004 <span class="comment">** This file is part of the QuickFIX FIX Engine</span>
00005 <span class="comment">**</span>
00006 <span class="comment">** This file may be distributed under the terms of the quickfixengine.org</span>
00007 <span class="comment">** license as defined by quickfixengine.org and appearing in the file</span>
00008 <span class="comment">** LICENSE included in the packaging of this file.</span>
00009 <span class="comment">**</span>
00010 <span class="comment">** This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE</span>
00011 <span class="comment">** WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
00012 <span class="comment">**</span>
00013 <span class="comment">** See http://www.quickfixengine.org/LICENSE for licensing information.</span>
00014 <span class="comment">**</span>
00015 <span class="comment">** Contact ask@quickfixengine.org if any conditions of this licensing are</span>
00016 <span class="comment">** not clear to you.</span>
00017 <span class="comment">**</span>
00018 <span class="comment">****************************************************************************/</span>
00019 
00020 <span class="preprocessor">#ifdef _MSC_VER</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#include "stdafx.h"</span>
00022 <span class="preprocessor">#else</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00024 <span class="preprocessor">#endif</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="_call_stack_8h.html">CallStack.h</a>"</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="_file_store_8h.html">FileStore.h</a>"</span>
00028 <span class="preprocessor">#include "<a class="code" href="_session_i_d_8h.html">SessionID.h</a>"</span>
00029 <span class="preprocessor">#include "<a class="code" href="_parser_8h.html">Parser.h</a>"</span>
00030 <span class="preprocessor">#include "<a class="code" href="_utility_8h.html">Utility.h</a>"</span>
00031 <span class="preprocessor">#include &lt;fstream&gt;</span>
00032 
00033 <span class="keyword">namespace </span>FIX
00034 {
<a name="l00035"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a0">00035</a> FileStore::FileStore( std::string path, <span class="keyword">const</span> <a class="code" href="class_f_i_x_1_1_session_i_d.html">SessionID</a>&amp; s )
00036 : m_msgFile( 0 ), m_headerFile( 0 ), m_seqNumsFile( 0 ), m_sessionFile( 0 )
00037 {
00038   <a class="code" href="namespace_f_i_x.html#a2946">file_mkdir</a>( path.c_str() );
00039 
00040   <span class="keywordflow">if</span> ( path.empty() ) path = <span class="stringliteral">"."</span>;
00041   <span class="keyword">const</span> std::string&amp; begin =
00042     s.<a class="code" href="class_f_i_x_1_1_session_i_d.html#a3">getBeginString</a>().getString();
00043   <span class="keyword">const</span> std::string&amp; sender =
00044     s.<a class="code" href="class_f_i_x_1_1_session_i_d.html#a4">getSenderCompID</a>().getString();
00045   <span class="keyword">const</span> std::string&amp; target =
00046     s.<a class="code" href="class_f_i_x_1_1_session_i_d.html#a5">getTargetCompID</a>().getString();
00047   <span class="keyword">const</span> std::string&amp; qualifier =
00048     s.<a class="code" href="class_f_i_x_1_1_session_i_d.html#a6">getSessionQualifier</a>();
00049 
00050   std::string sessionid = begin + <span class="stringliteral">"-"</span> + sender + <span class="stringliteral">"-"</span> + target;
00051   <span class="keywordflow">if</span>( qualifier.size() )
00052     sessionid += <span class="stringliteral">"-"</span> + qualifier;
00053 
00054   std::string prefix
00055     = <a class="code" href="namespace_f_i_x.html#a2949">file_appendpath</a>(path, sessionid + <span class="stringliteral">"."</span>);
00056 
00057   <a class="code" href="class_f_i_x_1_1_file_store.html#r2">m_msgFileName</a> = prefix + <span class="stringliteral">"body"</span>;
00058   <a class="code" href="class_f_i_x_1_1_file_store.html#r3">m_headerFileName</a> = prefix + <span class="stringliteral">"header"</span>;
00059   <a class="code" href="class_f_i_x_1_1_file_store.html#r4">m_seqNumsFileName</a> = prefix + <span class="stringliteral">"seqnums"</span>;
00060   <a class="code" href="class_f_i_x_1_1_file_store.html#r5">m_sessionFileName</a> = prefix + <span class="stringliteral">"session"</span>;
00061 
00062   <span class="keywordflow">try</span>
00063   {
00064     <a class="code" href="class_f_i_x_1_1_file_store.html#d0">open</a>( <span class="keyword">false</span> );
00065   }
00066   <span class="keywordflow">catch</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a> &amp; e )
00067   {
00068     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a>( e.what() );
00069   }
00070 }
00071 
<a name="l00072"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a1">00072</a> FileStore::~FileStore()
00073 {
00074   fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#r6">m_msgFile</a> );
00075   fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#r7">m_headerFile</a> );
00076   fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#r8">m_seqNumsFile</a> );
00077   fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#r9">m_sessionFile</a> );
00078 }
00079 
<a name="l00080"></a><a class="code" href="class_f_i_x_1_1_file_store.html#d0">00080</a> <span class="keywordtype">void</span> FileStore::open( <span class="keywordtype">bool</span> deleteFile )
00081 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStore::open)
00082 
00083   <span class="keywordflow">if</span> ( <a class="code" href="class_f_i_x_1_1_file_store.html#r6">m_msgFile</a> ) fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#r6">m_msgFile</a> );
00084   <span class="keywordflow">if</span> ( <a class="code" href="class_f_i_x_1_1_file_store.html#r7">m_headerFile</a> ) fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#r7">m_headerFile</a> );
00085   <span class="keywordflow">if</span> ( <a class="code" href="class_f_i_x_1_1_file_store.html#r8">m_seqNumsFile</a> ) fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#r8">m_seqNumsFile</a> );
00086   <span class="keywordflow">if</span> ( <a class="code" href="class_f_i_x_1_1_file_store.html#r9">m_sessionFile</a> ) fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#r9">m_sessionFile</a> );
00087 
00088   <span class="keywordflow">if</span> ( deleteFile )
00089   {
00090     <a class="code" href="namespace_f_i_x.html#a2948">file_unlink</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#r2">m_msgFileName</a>.c_str() );
00091     <a class="code" href="namespace_f_i_x.html#a2948">file_unlink</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#r3">m_headerFileName</a>.c_str() );
00092     <a class="code" href="namespace_f_i_x.html#a2948">file_unlink</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#r4">m_seqNumsFileName</a>.c_str() );
00093     <a class="code" href="namespace_f_i_x.html#a2948">file_unlink</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#r5">m_sessionFileName</a>.c_str() );
00094   }
00095 
00096   <a class="code" href="class_f_i_x_1_1_file_store.html#d1">populateCache</a>();
00097   <a class="code" href="class_f_i_x_1_1_file_store.html#r6">m_msgFile</a> = <a class="code" href="namespace_f_i_x.html#a2947">file_fopen</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#r2">m_msgFileName</a>.c_str(), <span class="stringliteral">"r+"</span> );
00098   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#r6">m_msgFile</a> ) <a class="code" href="class_f_i_x_1_1_file_store.html#r6">m_msgFile</a> = <a class="code" href="namespace_f_i_x.html#a2947">file_fopen</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#r2">m_msgFileName</a>.c_str(), <span class="stringliteral">"w+"</span> );
00099   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#r6">m_msgFile</a> ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a>( <span class="stringliteral">"Could not open body file: "</span> + <a class="code" href="class_f_i_x_1_1_file_store.html#r2">m_msgFileName</a> );
00100 
00101   <a class="code" href="class_f_i_x_1_1_file_store.html#r7">m_headerFile</a> = <a class="code" href="namespace_f_i_x.html#a2947">file_fopen</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#r3">m_headerFileName</a>.c_str(), <span class="stringliteral">"r+"</span> );
00102   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#r7">m_headerFile</a> ) <a class="code" href="class_f_i_x_1_1_file_store.html#r7">m_headerFile</a> = <a class="code" href="namespace_f_i_x.html#a2947">file_fopen</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#r3">m_headerFileName</a>.c_str(), <span class="stringliteral">"w+"</span> );
00103   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#r7">m_headerFile</a> ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a>( <span class="stringliteral">"Could not open header file: "</span> + <a class="code" href="class_f_i_x_1_1_file_store.html#r3">m_headerFileName</a> );
00104 
00105   <a class="code" href="class_f_i_x_1_1_file_store.html#r8">m_seqNumsFile</a> = <a class="code" href="namespace_f_i_x.html#a2947">file_fopen</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#r4">m_seqNumsFileName</a>.c_str(), <span class="stringliteral">"r+"</span> );
00106   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#r8">m_seqNumsFile</a> ) <a class="code" href="class_f_i_x_1_1_file_store.html#r8">m_seqNumsFile</a> = <a class="code" href="namespace_f_i_x.html#a2947">file_fopen</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#r4">m_seqNumsFileName</a>.c_str(), <span class="stringliteral">"w+"</span> );
00107   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#r8">m_seqNumsFile</a> ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a>( <span class="stringliteral">"Could not open seqnums file: "</span> + <a class="code" href="class_f_i_x_1_1_file_store.html#r4">m_seqNumsFileName</a> );
00108 
00109   <span class="keywordtype">bool</span> setCreationTime = <span class="keyword">false</span>;
00110   <a class="code" href="class_f_i_x_1_1_file_store.html#r9">m_sessionFile</a> = <a class="code" href="namespace_f_i_x.html#a2947">file_fopen</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#r5">m_sessionFileName</a>.c_str(), <span class="stringliteral">"r"</span> );
00111   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#r9">m_sessionFile</a> ) setCreationTime = <span class="keyword">true</span>;
00112   <span class="keywordflow">else</span> fclose( <a class="code" href="class_f_i_x_1_1_file_store.html#r9">m_sessionFile</a> );
00113 
00114   <a class="code" href="class_f_i_x_1_1_file_store.html#r9">m_sessionFile</a> = <a class="code" href="namespace_f_i_x.html#a2947">file_fopen</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#r5">m_sessionFileName</a>.c_str(), <span class="stringliteral">"r+"</span> );
00115   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#r9">m_sessionFile</a> ) <a class="code" href="class_f_i_x_1_1_file_store.html#r9">m_sessionFile</a> = <a class="code" href="namespace_f_i_x.html#a2947">file_fopen</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#r5">m_sessionFileName</a>.c_str(), <span class="stringliteral">"w+"</span> );
00116   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_file_store.html#r9">m_sessionFile</a> ) <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a>( <span class="stringliteral">"Could not open session file"</span> );
00117   <span class="keywordflow">if</span> ( setCreationTime ) <a class="code" href="class_f_i_x_1_1_file_store.html#d4">setSession</a>();
00118 
00119   <a class="code" href="class_f_i_x_1_1_file_store.html#a6">setNextSenderMsgSeqNum</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#a4">getNextSenderMsgSeqNum</a>() );
00120   <a class="code" href="class_f_i_x_1_1_file_store.html#a7">setNextTargetMsgSeqNum</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#a5">getNextTargetMsgSeqNum</a>() );
00121 
00122   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00123 }
00124 
<a name="l00125"></a><a class="code" href="class_f_i_x_1_1_file_store.html#d1">00125</a> <span class="keywordtype">void</span> FileStore::populateCache()
00126 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStore::populateCache)
00127 
00128   std::string msg;
00129   <a class="code" href="class_f_i_x_1_1_message.html">Message</a> message;
00130 
00131   FILE* headerFile;
00132   headerFile = <a class="code" href="namespace_f_i_x.html#a2947">file_fopen</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#r3">m_headerFileName</a>.c_str(), <span class="stringliteral">"r+"</span> );
00133   <span class="keywordflow">if</span> ( headerFile )
00134   {
00135     <span class="keywordtype">int</span> num, offset, size;
00136     <span class="keywordflow">while</span> ( <a class="code" href="_utility_8h.html#a2">FILE_FSCANF</a>( headerFile, <span class="stringliteral">"%d,%d,%d "</span>, &amp;num, &amp;offset, &amp;size ) == 3 )
00137       <a class="code" href="class_f_i_x_1_1_file_store.html#r1">m_offsets</a>[ num ] = std::make_pair( offset, size );
00138     fclose( headerFile );
00139   }
00140 
00141   FILE* seqNumsFile;
00142   seqNumsFile = <a class="code" href="namespace_f_i_x.html#a2947">file_fopen</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#r4">m_seqNumsFileName</a>.c_str(), <span class="stringliteral">"r+"</span> );
00143   <span class="keywordflow">if</span> ( seqNumsFile )
00144   {
00145     <span class="keywordtype">int</span> sender, target;
00146     <span class="keywordflow">if</span> ( <a class="code" href="_utility_8h.html#a2">FILE_FSCANF</a>( seqNumsFile, <span class="stringliteral">"%d : %d"</span>, &amp;sender, &amp;target ) == 2 )
00147     {
00148       <a class="code" href="class_f_i_x_1_1_file_store.html#r0">m_cache</a>.<a class="code" href="class_f_i_x_1_1_memory_store.html#a5">setNextSenderMsgSeqNum</a>( sender );
00149       <a class="code" href="class_f_i_x_1_1_file_store.html#r0">m_cache</a>.<a class="code" href="class_f_i_x_1_1_memory_store.html#a6">setNextTargetMsgSeqNum</a>( target );
00150     }
00151     fclose( seqNumsFile );
00152   }
00153 
00154   FILE* sessionFile;
00155   sessionFile = <a class="code" href="namespace_f_i_x.html#a2947">file_fopen</a>( <a class="code" href="class_f_i_x_1_1_file_store.html#r5">m_sessionFileName</a>.c_str(), <span class="stringliteral">"r+"</span> );
00156   <span class="keywordflow">if</span> ( sessionFile )
00157   {
00158     <span class="keywordtype">char</span> time[ 22 ];
00159 <span class="preprocessor">#ifdef HAVE_FSCANF_S</span>
00160 <span class="preprocessor"></span>    <span class="keywordtype">int</span> result = <a class="code" href="_utility_8h.html#a2">FILE_FSCANF</a>( sessionFile, <span class="stringliteral">"%s"</span>, time, 22 );
00161 <span class="preprocessor">#else</span>
00162 <span class="preprocessor"></span>    <span class="keywordtype">int</span> result = <a class="code" href="_utility_8h.html#a2">FILE_FSCANF</a>( sessionFile, <span class="stringliteral">"%s"</span>, time );
00163 <span class="preprocessor">#endif</span>
00164 <span class="preprocessor"></span>    <span class="keywordflow">if</span>( result == 1 )
00165     {
00166       <a class="code" href="class_f_i_x_1_1_file_store.html#r0">m_cache</a>.<a class="code" href="class_f_i_x_1_1_memory_store.html#a9">setCreationTime</a>( UtcTimeStampConvertor::convert( time, <span class="keyword">true</span> ) );
00167     }
00168     fclose( sessionFile );
00169   }
00170 
00171   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00172 }
00173 
<a name="l00174"></a><a class="code" href="class_f_i_x_1_1_file_store_factory.html#a2">00174</a> <a class="code" href="class_f_i_x_1_1_message_store.html">MessageStore</a>* FileStoreFactory::create( <span class="keyword">const</span> <a class="code" href="class_f_i_x_1_1_session_i_d.html">SessionID</a>&amp; s )
00175 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStoreFactory::create)
00176 
00177   <span class="keywordflow">if</span> ( m_path.size() ) <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="class_f_i_x_1_1_file_store.html">FileStore</a>( m_path, s );
00178 
00179   std::string path;
00180   <a class="code" href="class_f_i_x_1_1_dictionary.html">Dictionary</a> settings = m_settings.<a class="code" href="class_f_i_x_1_1_session_settings.html#a4">get</a>( s );
00181   path = settings.<a class="code" href="class_f_i_x_1_1_dictionary.html#a5">getString</a>( <a class="code" href="namespace_f_i_x.html#a185">FILE_STORE_PATH</a> );
00182   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="class_f_i_x_1_1_file_store.html">FileStore</a>( path, s );
00183 
00184   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00185 }
00186 
<a name="l00187"></a><a class="code" href="class_f_i_x_1_1_file_store_factory.html#a3">00187</a> <span class="keywordtype">void</span> FileStoreFactory::destroy( <a class="code" href="class_f_i_x_1_1_message_store.html">MessageStore</a>* pStore )
00188 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStoreFactory::destroy)
00189   <span class="keyword">delete</span> pStore;
00190   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00191 }
00192 
<a name="l00193"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a2">00193</a> <span class="keywordtype">bool</span> FileStore::set( <span class="keywordtype">int</span> msgSeqNum, <span class="keyword">const</span> std::string&amp; msg )
00194 <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a> )
00195 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStore::set)
00196 
00197   <span class="keywordflow">if</span> ( fseek( m_msgFile, 0, SEEK_END ) ) 
00198     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>( <span class="stringliteral">"Cannot seek to end of "</span> + m_msgFileName );
00199   <span class="keywordflow">if</span> ( fseek( m_headerFile, 0, SEEK_END ) ) 
00200     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>( <span class="stringliteral">"Cannot seek to end of "</span> + m_headerFileName );
00201 
00202   <span class="keywordtype">int</span> offset = ftell( m_msgFile );
00203   <span class="keywordflow">if</span> ( offset &lt; 0 ) 
00204     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>( <span class="stringliteral">"Unable to get file pointer position from "</span> + m_msgFileName );
00205   <span class="keywordtype">int</span> size = msg.size();
00206 
00207   <span class="keywordflow">if</span> ( fprintf( m_headerFile, <span class="stringliteral">"%d,%d,%d "</span>, msgSeqNum, offset, size ) &lt; 0 )
00208     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>( <span class="stringliteral">"Unable to write to file "</span> + m_headerFileName );
00209   m_offsets[ msgSeqNum ] = std::make_pair( offset, size );
00210   fwrite( msg.c_str(), <span class="keyword">sizeof</span>( <span class="keywordtype">char</span> ), msg.size(), m_msgFile );
00211   <span class="keywordflow">if</span> ( ferror( m_msgFile ) ) 
00212     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>( <span class="stringliteral">"Unable to write to file "</span> + m_msgFileName );
00213   <span class="keywordflow">if</span> ( fflush( m_msgFile ) == EOF ) 
00214     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>( <span class="stringliteral">"Unable to flush file "</span> + m_msgFileName );
00215   <span class="keywordflow">if</span> ( fflush( m_headerFile ) == EOF ) 
00216     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>( <span class="stringliteral">"Unable to flush file "</span> + m_headerFileName );
00217   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00218 
00219   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00220 }
00221 
<a name="l00222"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a3">00222</a> <span class="keywordtype">void</span> FileStore::get( <span class="keywordtype">int</span> begin, <span class="keywordtype">int</span> end,
00223                      std::vector &lt; std::string &gt; &amp; result ) <span class="keyword">const</span>
00224 <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a> )
00225 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStore::get)
00226 
00227   result.clear();
00228   std::string msg;
00229   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = begin; i &lt;= end; ++i )
00230   {
00231     <span class="keywordflow">if</span> ( get( i, msg ) )
00232       result.push_back( msg );
00233   }
00234 
00235   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00236 }
00237 
<a name="l00238"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a4">00238</a> <span class="keywordtype">int</span> FileStore::getNextSenderMsgSeqNum() <span class="keyword">const</span> <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a> )
00239 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStore::getNextSenderMsgSeqNum)
00240   <span class="keywordflow">return</span> m_cache.getNextSenderMsgSeqNum();
00241   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00242 }
00243 
<a name="l00244"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a5">00244</a> <span class="keywordtype">int</span> FileStore::getNextTargetMsgSeqNum() <span class="keyword">const</span> <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a> )
00245 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStore::getNextTargetMsgSeqNum)
00246   <span class="keywordflow">return</span> m_cache.getNextTargetMsgSeqNum();
00247   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00248 }
00249 
<a name="l00250"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a6">00250</a> <span class="keywordtype">void</span> FileStore::setNextSenderMsgSeqNum( <span class="keywordtype">int</span> value ) <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a> )
00251 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStore::setNextSenderMsgSeqNum)
00252   m_cache.setNextSenderMsgSeqNum( value );
00253   setSeqNum();
00254   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00255 }
00256 
<a name="l00257"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a7">00257</a> <span class="keywordtype">void</span> FileStore::setNextTargetMsgSeqNum( <span class="keywordtype">int</span> value ) <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a> )
00258 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStore::setNextTargetMsgSeqNum)
00259   m_cache.setNextTargetMsgSeqNum( value );
00260   setSeqNum();
00261   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00262 }
00263 
<a name="l00264"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a8">00264</a> <span class="keywordtype">void</span> FileStore::incrNextSenderMsgSeqNum() <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a> )
00265 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStore::incrNextSenderMsgSeqNum)
00266   m_cache.incrNextSenderMsgSeqNum();
00267   setSeqNum();
00268   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00269 }
00270 
<a name="l00271"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a9">00271</a> <span class="keywordtype">void</span> FileStore::incrNextTargetMsgSeqNum() <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a> )
00272 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStore::incrNextTargetMsgSeqNum)
00273   m_cache.incrNextTargetMsgSeqNum();
00274   setSeqNum();
00275   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00276 }
00277 
<a name="l00278"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a10">00278</a> <a class="code" href="class_f_i_x_1_1_utc_time_stamp.html">UtcTimeStamp</a> FileStore::getCreationTime() <span class="keyword">const</span> <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a> )
00279 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStore::getCreationTime)
00280   <span class="keywordflow">return</span> m_cache.getCreationTime();
00281   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00282 }
00283 
<a name="l00284"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a11">00284</a> <span class="keywordtype">void</span> FileStore::reset() <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a> )
00285 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStore::reset)
00286 
00287   m_cache.reset();
00288   open( <span class="keyword">true</span> );
00289   setSession();
00290 
00291   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00292 }
00293 
<a name="l00294"></a><a class="code" href="class_f_i_x_1_1_file_store.html#a12">00294</a> <span class="keywordtype">void</span> FileStore::refresh() <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a> )
00295 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStore::refresh)
00296 
00297   m_cache.reset();
00298   open( <span class="keyword">false</span> );
00299 
00300   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00301 }
00302 
<a name="l00303"></a><a class="code" href="class_f_i_x_1_1_file_store.html#d3">00303</a> <span class="keywordtype">void</span> FileStore::setSeqNum()
00304 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStore::setSeqNum)
00305 
00306   rewind( <a class="code" href="class_f_i_x_1_1_file_store.html#r8">m_seqNumsFile</a> );
00307   fprintf( <a class="code" href="class_f_i_x_1_1_file_store.html#r8">m_seqNumsFile</a>, <span class="stringliteral">"%10.10d : %10.10d"</span>,
00308            <a class="code" href="class_f_i_x_1_1_file_store.html#a4">getNextSenderMsgSeqNum</a>(), <a class="code" href="class_f_i_x_1_1_file_store.html#a5">getNextTargetMsgSeqNum</a>() );
00309   <span class="keywordflow">if</span> ( ferror( <a class="code" href="class_f_i_x_1_1_file_store.html#r8">m_seqNumsFile</a> ) ) 
00310     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>( <span class="stringliteral">"Unable to write to file "</span> + <a class="code" href="class_f_i_x_1_1_file_store.html#r4">m_seqNumsFileName</a> );
00311   <span class="keywordflow">if</span> ( fflush( <a class="code" href="class_f_i_x_1_1_file_store.html#r8">m_seqNumsFile</a> ) ) 
00312     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>( <span class="stringliteral">"Unable to flush file "</span> + <a class="code" href="class_f_i_x_1_1_file_store.html#r4">m_seqNumsFileName</a> );
00313 
00314   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00315 }
00316 
<a name="l00317"></a><a class="code" href="class_f_i_x_1_1_file_store.html#d4">00317</a> <span class="keywordtype">void</span> FileStore::setSession()
00318 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStore::setSession)
00319 
00320   rewind( <a class="code" href="class_f_i_x_1_1_file_store.html#r9">m_sessionFile</a> );
00321   fprintf( <a class="code" href="class_f_i_x_1_1_file_store.html#r9">m_sessionFile</a>, <span class="stringliteral">"%s"</span>,
00322            UtcTimeStampConvertor::convert( <a class="code" href="class_f_i_x_1_1_file_store.html#r0">m_cache</a>.<a class="code" href="class_f_i_x_1_1_memory_store.html#a10">getCreationTime</a>() ).c_str() );
00323   <span class="keywordflow">if</span> ( ferror( <a class="code" href="class_f_i_x_1_1_file_store.html#r9">m_sessionFile</a> ) ) 
00324     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>( <span class="stringliteral">"Unable to write to file "</span> + <a class="code" href="class_f_i_x_1_1_file_store.html#r5">m_sessionFileName</a> );
00325   <span class="keywordflow">if</span> ( fflush( <a class="code" href="class_f_i_x_1_1_file_store.html#r9">m_sessionFile</a> ) ) 
00326     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>( <span class="stringliteral">"Unable to flush file "</span> + <a class="code" href="class_f_i_x_1_1_file_store.html#r5">m_sessionFileName</a> );
00327 
00328   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00329 }
00330 
<a name="l00331"></a><a class="code" href="class_f_i_x_1_1_file_store.html#d5">00331</a> <span class="keywordtype">bool</span> FileStore::get( <span class="keywordtype">int</span> msgSeqNum, std::string&amp; msg ) <span class="keyword">const</span>
00332 <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a> )
00333 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(FileStore::get)
00334 
00335   NumToOffset::const_iterator find = m_offsets.find( msgSeqNum );
00336   <span class="keywordflow">if</span> ( find == m_offsets.end() ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00337   <span class="keyword">const</span> <a class="code" href="class_f_i_x_1_1_file_store.html#y0">OffsetSize</a>&amp; offset = find-&gt;second;
00338   <span class="keywordflow">if</span> ( fseek( m_msgFile, offset.first, SEEK_SET ) ) 
00339     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>( <span class="stringliteral">"Unable to seek in file "</span> + m_msgFileName );
00340   <span class="keywordtype">char</span>* buffer = <span class="keyword">new</span> <span class="keywordtype">char</span>[ offset.second + 1 ];
00341   fread( buffer, <span class="keyword">sizeof</span>( <span class="keywordtype">char</span> ), offset.second, m_msgFile );
00342   <span class="keywordflow">if</span> ( ferror( m_msgFile ) ) 
00343     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_i_o_exception.html">IOException</a>( <span class="stringliteral">"Unable to read from file "</span> + m_msgFileName );
00344   buffer[ offset.second ] = 0;
00345   msg = buffer;
00346   <span class="keyword">delete</span> [] buffer;
00347   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00348 
00349   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00350 }
00351 
00352 } <span class="comment">//namespace FIX</span>
</pre></div><hr><address><small>
Generated on Thu Sep 14 08:52:35 2006 for QuickFIX by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.6-20040222 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
