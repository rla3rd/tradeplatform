<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/home/orenmnero/autobuild/quickfix/src/C++/OdbcStore.cpp Source File</title>
<link href="quickfix.css" rel="stylesheet" type="text/css">
<table cellspacing="0" cellpadding="0" border="0">
  <tr>
   <td><img src="images/outsideTopLeft.gif"></td>
   <td width="100%" class="outsideTop">&nbsp;</td>
   <td><img src="images/outsideTopRight.gif"></td>
  </tr>
  <tr>
   <td class="outsideLeft">&nbsp;</td>
   <td>
	<img src="images/QuickFIX.jpg" align="middle" border=0>
	&nbsp;&nbsp;
	<a href="index.html">Index</a>&nbsp;
	<a href="files.html">Source Files</a>&nbsp;
	<a href="annotated.html">Annotated Class List</a>&nbsp;
	<a href="classes.html">Alphabetical Class List</a>&nbsp;
	<a href="hierarchy.html">Class Hierarchy</a>&nbsp;
	<a href="inherits.html">Graphical Class Hierarchy</a>&nbsp;
   </td>
   <td class="outsideRight">&nbsp;</td>
  </tr>
  <tr>
   <td><img src="images/outsideBottomLeft.gif"></td>
   <td width=100% class="outsideBottom">&nbsp;</td>
   <td><img src="images/outsideBottomRight.gif"></td>
  </tr>
</table>
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.3.6-20040222 -->
<h1>/home/orenmnero/autobuild/quickfix/src/C++/OdbcStore.cpp</h1><a href="_odbc_store_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">** Copyright (c) quickfixengine.org  All rights reserved.</span>
00003 <span class="comment">**</span>
00004 <span class="comment">** This file is part of the QuickFIX FIX Engine</span>
00005 <span class="comment">**</span>
00006 <span class="comment">** This file may be distributed under the terms of the quickfixengine.org</span>
00007 <span class="comment">** license as defined by quickfixengine.org and appearing in the file</span>
00008 <span class="comment">** LICENSE included in the packaging of this file.</span>
00009 <span class="comment">**</span>
00010 <span class="comment">** This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE</span>
00011 <span class="comment">** WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
00012 <span class="comment">**</span>
00013 <span class="comment">** See http://www.quickfixengine.org/LICENSE for licensing information.</span>
00014 <span class="comment">**</span>
00015 <span class="comment">** Contact ask@quickfixengine.org if any conditions of this licensing are</span>
00016 <span class="comment">** not clear to you.</span>
00017 <span class="comment">**</span>
00018 <span class="comment">****************************************************************************/</span>
00019 
00020 <span class="preprocessor">#ifdef _MSC_VER</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#include "stdafx.h"</span>
00022 <span class="preprocessor">#else</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00024 <span class="preprocessor">#endif</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="_call_stack_8h.html">CallStack.h</a>"</span>
00026 
00027 <span class="preprocessor">#ifdef HAVE_ODBC</span>
00028 <span class="preprocessor"></span>
00029 <span class="preprocessor">#include "<a class="code" href="_odbc_store_8h.html">OdbcStore.h</a>"</span>
00030 <span class="preprocessor">#include "<a class="code" href="_session_i_d_8h.html">SessionID.h</a>"</span>
00031 <span class="preprocessor">#include "<a class="code" href="_session_settings_8h.html">SessionSettings.h</a>"</span>
00032 <span class="preprocessor">#include "<a class="code" href="_field_convertors_8h.html">FieldConvertors.h</a>"</span>
00033 <span class="preprocessor">#include "<a class="code" href="_parser_8h.html">Parser.h</a>"</span>
00034 <span class="preprocessor">#include "<a class="code" href="_utility_8h.html">Utility.h</a>"</span>
00035 <span class="preprocessor">#include "strptime.h"</span>
00036 <span class="preprocessor">#include &lt;fstream&gt;</span>
00037 
00038 <span class="keyword">namespace </span>FIX
00039 {
00040 
00041 <span class="keyword">const</span> std::string OdbcStoreFactory::DEFAULT_USER = <span class="stringliteral">"sa"</span>;
00042 <span class="keyword">const</span> std::string OdbcStoreFactory::DEFAULT_PASSWORD = <span class="stringliteral">""</span>;
00043 <span class="keyword">const</span> std::string OdbcStoreFactory::DEFAULT_CONNECTION_STRING 
00044   = <span class="stringliteral">"DATABASE=quickfix;DRIVER={SQL Server};SERVER=(local);"</span>;
00045 
00046 OdbcStore::OdbcStore
00047 ( <span class="keyword">const</span> SessionID&amp; s, <span class="keyword">const</span> std::string&amp; user, <span class="keyword">const</span> std::string&amp; password, 
00048   <span class="keyword">const</span> std::string&amp; connectionString )
00049   : m_sessionID( s )
00050 {
00051   m_pConnection = <span class="keyword">new</span> OdbcConnection( user, password, connectionString );
00052   populateCache();
00053 }
00054 
00055 OdbcStore::~OdbcStore()
00056 {
00057   <span class="keyword">delete</span> m_pConnection;
00058 }
00059 
00060 <span class="keywordtype">void</span> OdbcStore::populateCache()
00061 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(OdbcStore::populateCache)
00062 
00063   std::stringstream queryString;
00064 
00065   queryString &lt;&lt; <span class="stringliteral">"SELECT creation_time, incoming_seqnum, outgoing_seqnum FROM sessions WHERE "</span>
00066   &lt;&lt; <span class="stringliteral">"beginstring="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getBeginString().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00067   &lt;&lt; <span class="stringliteral">"sendercompid="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSenderCompID().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00068   &lt;&lt; <span class="stringliteral">"targetcompid="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getTargetCompID().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00069   &lt;&lt; <span class="stringliteral">"session_qualifier="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSessionQualifier() &lt;&lt; <span class="stringliteral">"'"</span>;
00070 
00071   OdbcQuery query( queryString.str() );
00072 
00073   <span class="keywordflow">if</span>( !m_pConnection-&gt;execute(query) )
00074     <span class="keywordflow">throw</span> <span class="keyword">new</span> ConfigError( <span class="stringliteral">"Unable to connect to database"</span> );
00075   
00076   <span class="keywordtype">int</span> rows = 0;
00077   <span class="keywordflow">while</span>( query.fetch() )
00078   {
00079     rows++;
00080     <span class="keywordflow">if</span>( rows &gt; 1 )
00081       <span class="keywordflow">throw</span> ConfigError( <span class="stringliteral">"Multiple entries found for session in database"</span> );
00082 
00083     SQL_TIMESTAMP_STRUCT creationTime;  
00084     SQLINTEGER creationTimeLength;
00085     SQLGetData( query.statement(), 1, SQL_C_TYPE_TIMESTAMP, &amp;creationTime, 0, &amp;creationTimeLength );
00086     SQLINTEGER incomingSeqNum;
00087     SQLINTEGER incomingSeqNumLength;
00088     SQLGetData( query.statement(), 2, SQL_C_SLONG, &amp;incomingSeqNum, 0, &amp;incomingSeqNumLength );
00089 
00090     SQLINTEGER outgoingSeqNum;
00091     SQLINTEGER outgoingSeqNumLength;
00092     SQLGetData( query.statement(), 3, SQL_C_SLONG, &amp;outgoingSeqNum, 0, &amp;outgoingSeqNumLength );
00093 
00094     <a class="code" href="namespace_f_i_x_1_1_t_y_p_e.html#a26a10">UtcTimeStamp</a> time;
00095     time.setYMD( creationTime.year, creationTime.month, creationTime.day );
00096     time.setHMS( creationTime.hour, creationTime.minute, creationTime.second, creationTime.fraction );
00097     m_cache.setCreationTime( time );
00098     m_cache.setNextTargetMsgSeqNum( incomingSeqNum );
00099     m_cache.setNextSenderMsgSeqNum( outgoingSeqNum );
00100   }
00101   query.close();
00102 
00103   <span class="keywordflow">if</span>( rows == 0 )
00104   {
00105     <a class="code" href="namespace_f_i_x_1_1_t_y_p_e.html#a26a10">UtcTimeStamp</a> time = m_cache.getCreationTime();
00106     <span class="keywordtype">char</span> sqlTime[ 20 ];
00107     <span class="keywordtype">int</span> year, month, day, hour, minute, second, millis;
00108     time.getYMD (year, month, day);
00109     time.getHMS (hour, minute, second, millis);
00110     <a class="code" href="_utility_8h.html#a3">STRING_SPRINTF</a> (sqlTime, <span class="stringliteral">"%d-%02d-%02d %02d:%02d:%02d"</span>,
00111              year, month, day, hour, minute, second);
00112     std::stringstream queryString2;
00113     queryString2 &lt;&lt; <span class="stringliteral">"INSERT INTO sessions (beginstring, sendercompid, targetcompid, session_qualifier,"</span>
00114     &lt;&lt; <span class="stringliteral">"creation_time, incoming_seqnum, outgoing_seqnum) VALUES("</span>
00115     &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getBeginString().getValue() &lt;&lt; <span class="stringliteral">"',"</span>
00116     &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSenderCompID().getValue() &lt;&lt; <span class="stringliteral">"',"</span>
00117     &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getTargetCompID().getValue() &lt;&lt; <span class="stringliteral">"',"</span>
00118     &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSessionQualifier() &lt;&lt; <span class="stringliteral">"',"</span>
00119         &lt;&lt; <span class="stringliteral">"{ts '"</span> &lt;&lt; sqlTime &lt;&lt; <span class="stringliteral">"'},"</span>
00120     &lt;&lt; m_cache.getNextTargetMsgSeqNum() &lt;&lt; <span class="stringliteral">","</span>
00121     &lt;&lt; m_cache.getNextSenderMsgSeqNum() &lt;&lt; <span class="stringliteral">")"</span>;
00122 
00123     OdbcQuery query2( queryString2.str() );
00124     <span class="keywordflow">if</span>( !m_pConnection-&gt;execute(query2) )
00125       <span class="keywordflow">throw</span> ConfigError( <span class="stringliteral">"Unable to create session in database"</span> );
00126   }
00127 
00128   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00129 }
00130 
00131 MessageStore* OdbcStoreFactory::create( <span class="keyword">const</span> SessionID&amp; s )
00132 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(OdbcStoreFactory::create)
00133 
00134   <span class="keywordflow">if</span>( m_useSettings )
00135     <span class="keywordflow">return</span> create( s, m_settings.get(s) );
00136   <span class="keywordflow">else</span> <span class="keywordflow">if</span>( m_useDictionary )
00137     <span class="keywordflow">return</span> create( s, m_dictionary );
00138   <span class="keywordflow">else</span>
00139     <span class="keywordflow">return</span> <span class="keyword">new</span> OdbcStore( s, m_user, m_password, m_connectionString );
00140 
00141   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00142 }
00143 
00144 <span class="keywordtype">void</span> OdbcStoreFactory::destroy( MessageStore* pStore )
00145 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(OdbcStoreFactory::destroy)
00146   <span class="keyword">delete</span> pStore;
00147   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00148 }
00149 
00150 MessageStore* OdbcStoreFactory::create( <span class="keyword">const</span> SessionID&amp; s, <span class="keyword">const</span> Dictionary&amp; settings )
00151 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(OdbcStoreFactory::create)
00152 
00153   std::string user = DEFAULT_USER;
00154   std::string password = DEFAULT_PASSWORD;
00155   std::string connectionString = DEFAULT_CONNECTION_STRING;
00156 
00157   <span class="keywordflow">try</span> { user = settings.getString( ODBC_STORE_USER ); }
00158   <span class="keywordflow">catch</span>( ConfigError&amp; ) {}
00159 
00160   <span class="keywordflow">try</span> { password = settings.getString( ODBC_STORE_PASSWORD ); }
00161   <span class="keywordflow">catch</span>( ConfigError&amp; ) {}
00162 
00163   <span class="keywordflow">try</span> { connectionString = settings.getString( ODBC_STORE_CONNECTION_STRING ); }
00164   <span class="keywordflow">catch</span>( ConfigError&amp; ) {}
00165 
00166   <span class="keywordflow">return</span> <span class="keyword">new</span> OdbcStore( s, user, password, connectionString );
00167 
00168   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00169 }
00170 
00171 <span class="keywordtype">bool</span> OdbcStore::set( <span class="keywordtype">int</span> msgSeqNum, <span class="keyword">const</span> std::string&amp; msg )
00172 <span class="keywordflow">throw</span> ( IOException )
00173 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(OdbcStore::set)
00174 
00175   std::string msgCopy = msg;
00176   <a class="code" href="namespace_f_i_x.html#a2910">string_replace</a>( <span class="stringliteral">"\""</span>, <span class="stringliteral">"\\\""</span>, msgCopy );
00177 
00178   std::stringstream queryString;
00179   queryString &lt;&lt; <span class="stringliteral">"INSERT INTO messages "</span>
00180   &lt;&lt; <span class="stringliteral">"(beginstring, sendercompid, targetcompid, session_qualifier, msgseqnum, message) "</span>
00181   &lt;&lt; <span class="stringliteral">"VALUES ("</span>
00182   &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getBeginString().getValue() &lt;&lt; <span class="stringliteral">"',"</span>
00183   &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSenderCompID().getValue() &lt;&lt; <span class="stringliteral">"',"</span>
00184   &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getTargetCompID().getValue() &lt;&lt; <span class="stringliteral">"',"</span>
00185   &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSessionQualifier() &lt;&lt; <span class="stringliteral">"',"</span>
00186   &lt;&lt; msgSeqNum &lt;&lt; <span class="stringliteral">","</span>
00187   &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; msgCopy &lt;&lt; <span class="stringliteral">"')"</span>;
00188 
00189   OdbcQuery query( queryString.str() );
00190   <span class="keywordflow">if</span>( !m_pConnection-&gt;execute(query) )
00191   {
00192     query.close();
00193     std::stringstream queryString2;
00194     queryString2 &lt;&lt; <span class="stringliteral">"UPDATE messages SET message=\""</span> &lt;&lt; msg &lt;&lt; <span class="stringliteral">"\" WHERE "</span>
00195     &lt;&lt; <span class="stringliteral">"beginstring="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getBeginString().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00196     &lt;&lt; <span class="stringliteral">"sendercompid="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSenderCompID().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00197     &lt;&lt; <span class="stringliteral">"targetcompid="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getTargetCompID().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00198     &lt;&lt; <span class="stringliteral">"session_qualifier="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSessionQualifier() &lt;&lt; <span class="stringliteral">"' and "</span>
00199     &lt;&lt; <span class="stringliteral">"msgseqnum="</span> &lt;&lt; msgSeqNum;
00200     OdbcQuery query2( queryString2.str() );
00201     <span class="keywordflow">if</span>( !m_pConnection-&gt;execute(query2) )
00202       query.throwException();
00203   }
00204   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00205 
00206   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00207 }
00208 
00209 <span class="keywordtype">void</span> OdbcStore::get( <span class="keywordtype">int</span> begin, <span class="keywordtype">int</span> end,
00210                     std::vector &lt; std::string &gt; &amp; result ) <span class="keyword">const</span>
00211 <span class="keywordflow">throw</span> ( IOException )
00212 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(OdbcStore::get)
00213 
00214   result.clear();
00215   std::stringstream queryString;
00216   queryString &lt;&lt; <span class="stringliteral">"SELECT message FROM messages WHERE "</span>
00217   &lt;&lt; <span class="stringliteral">"beginstring="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getBeginString().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00218   &lt;&lt; <span class="stringliteral">"sendercompid="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSenderCompID().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00219   &lt;&lt; <span class="stringliteral">"targetcompid="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getTargetCompID().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00220   &lt;&lt; <span class="stringliteral">"session_qualifier="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSessionQualifier() &lt;&lt; <span class="stringliteral">"' and "</span>
00221   &lt;&lt; <span class="stringliteral">"msgseqnum&gt;="</span> &lt;&lt; begin &lt;&lt; <span class="stringliteral">" and "</span> &lt;&lt; <span class="stringliteral">"msgseqnum&lt;="</span> &lt;&lt; end &lt;&lt; <span class="stringliteral">" "</span>
00222   &lt;&lt; <span class="stringliteral">"ORDER BY msgseqnum"</span>;
00223 
00224   OdbcQuery query( queryString.str() );
00225 
00226   <span class="keywordflow">if</span>( !m_pConnection-&gt;execute(query) )
00227     query.throwException();
00228 
00229   <span class="keywordflow">while</span>( query.fetch() )
00230   {
00231     std::string message;
00232     SQLVARCHAR messageBuffer[4096];
00233     SQLINTEGER messageLength;
00234 
00235     <span class="keywordflow">while</span>( odbcSuccess(SQLGetData( query.statement(), 1, SQL_C_CHAR, &amp;messageBuffer, 4095, &amp;messageLength)) )
00236     {  
00237       messageBuffer[messageLength] = 0;
00238       message += (<span class="keywordtype">char</span>*)messageBuffer;
00239     }
00240 
00241     result.push_back( message );
00242   }
00243 
00244   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00245 }
00246 
00247 <span class="keywordtype">int</span> OdbcStore::getNextSenderMsgSeqNum() <span class="keyword">const</span> <span class="keywordflow">throw</span> ( IOException )
00248 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(OdbcStore::getNextSenderMsgSeqNum)
00249   <span class="keywordflow">return</span> m_cache.getNextSenderMsgSeqNum();
00250   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00251 }
00252 
00253 <span class="keywordtype">int</span> OdbcStore::getNextTargetMsgSeqNum() <span class="keyword">const</span> <span class="keywordflow">throw</span> ( IOException )
00254 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(OdbcStore::getNextTargetMsgSeqNum)
00255   <span class="keywordflow">return</span> m_cache.getNextTargetMsgSeqNum();
00256   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00257 }
00258 
00259 <span class="keywordtype">void</span> OdbcStore::setNextSenderMsgSeqNum( <span class="keywordtype">int</span> value ) <span class="keywordflow">throw</span> ( IOException )
00260 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(OdbcStore::setNextSenderMsgSeqNum)
00261 
00262   std::stringstream queryString;
00263   queryString &lt;&lt; <span class="stringliteral">"UPDATE sessions SET outgoing_seqnum="</span> &lt;&lt; value &lt;&lt; <span class="stringliteral">" WHERE "</span>
00264   &lt;&lt; <span class="stringliteral">"beginstring="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getBeginString().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00265   &lt;&lt; <span class="stringliteral">"sendercompid="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSenderCompID().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00266   &lt;&lt; <span class="stringliteral">"targetcompid="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getTargetCompID().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00267   &lt;&lt; <span class="stringliteral">"session_qualifier="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSessionQualifier() &lt;&lt; <span class="stringliteral">"'"</span>;
00268   OdbcQuery query( queryString.str() );
00269   <span class="keywordflow">if</span>( !m_pConnection-&gt;execute(query) )
00270     query.throwException();
00271   m_cache.setNextSenderMsgSeqNum( value );
00272 
00273   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00274 }
00275 
00276 <span class="keywordtype">void</span> OdbcStore::setNextTargetMsgSeqNum( <span class="keywordtype">int</span> value ) <span class="keywordflow">throw</span> ( IOException )
00277 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(OdbcStore::setNextTargetMsgSeqNum)
00278 
00279   std::stringstream queryString;
00280   queryString &lt;&lt; <span class="stringliteral">"UPDATE sessions SET incoming_seqnum="</span> &lt;&lt; value &lt;&lt; <span class="stringliteral">" WHERE "</span>
00281   &lt;&lt; <span class="stringliteral">"beginstring="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getBeginString().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00282   &lt;&lt; <span class="stringliteral">"sendercompid="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSenderCompID().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00283   &lt;&lt; <span class="stringliteral">"targetcompid="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getTargetCompID().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00284   &lt;&lt; <span class="stringliteral">"session_qualifier="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSessionQualifier() &lt;&lt; <span class="stringliteral">"'"</span>;
00285 
00286   OdbcQuery query( queryString.str() );
00287   <span class="keywordflow">if</span>( !m_pConnection-&gt;execute(query) )
00288     query.throwException();
00289 
00290   m_cache.setNextTargetMsgSeqNum( value );
00291 
00292   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00293 }
00294 
00295 <span class="keywordtype">void</span> OdbcStore::incrNextSenderMsgSeqNum() <span class="keywordflow">throw</span> ( IOException )
00296 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(OdbcStore::incrNextSenderMsgSeqNum)
00297   m_cache.incrNextSenderMsgSeqNum();
00298   setNextSenderMsgSeqNum( m_cache.getNextSenderMsgSeqNum() );
00299   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00300 }
00301 
00302 <span class="keywordtype">void</span> OdbcStore::incrNextTargetMsgSeqNum() <span class="keywordflow">throw</span> ( IOException )
00303 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(OdbcStore::incrNextTargetMsgSeqNum)
00304   m_cache.incrNextTargetMsgSeqNum();
00305   setNextTargetMsgSeqNum( m_cache.getNextTargetMsgSeqNum() );
00306   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00307 }
00308 
00309 <a class="code" href="namespace_f_i_x_1_1_t_y_p_e.html#a26a10">UtcTimeStamp</a> OdbcStore::getCreationTime() <span class="keyword">const</span> <span class="keywordflow">throw</span> ( IOException )
00310 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(OdbcStore::getCreationTime)
00311   <span class="keywordflow">return</span> m_cache.getCreationTime();
00312   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00313 }
00314 
00315 <span class="keywordtype">void</span> OdbcStore::reset() <span class="keywordflow">throw</span> ( IOException )
00316 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(OdbcStore::reset)
00317 
00318   std::stringstream queryString;
00319   queryString &lt;&lt; <span class="stringliteral">"DELETE FROM messages WHERE "</span>
00320   &lt;&lt; <span class="stringliteral">"beginstring="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getBeginString().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00321   &lt;&lt; <span class="stringliteral">"sendercompid="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSenderCompID().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00322   &lt;&lt; <span class="stringliteral">"targetcompid="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getTargetCompID().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00323   &lt;&lt; <span class="stringliteral">"session_qualifier="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSessionQualifier() &lt;&lt; <span class="stringliteral">"'"</span>;
00324 
00325   OdbcQuery query( queryString.str() );
00326   <span class="keywordflow">if</span>( !m_pConnection-&gt;execute(query) )
00327     query.throwException();
00328   query.close();
00329 
00330   m_cache.reset();
00331   <a class="code" href="namespace_f_i_x_1_1_t_y_p_e.html#a26a10">UtcTimeStamp</a> time = m_cache.getCreationTime();
00332 
00333   <span class="keywordtype">int</span> year, month, day, hour, minute, second, millis;
00334   time.getYMD( year, month, day );
00335   time.getHMS( hour, minute, second, millis );
00336 
00337   <span class="keywordtype">char</span> sqlTime[ 20 ];
00338   <a class="code" href="_utility_8h.html#a3">STRING_SPRINTF</a>( sqlTime, <span class="stringliteral">"%d-%02d-%02d %02d:%02d:%02d"</span>,
00339            year, month, day, hour, minute, second );
00340 
00341   std::stringstream queryString2;
00342   queryString2 &lt;&lt; <span class="stringliteral">"UPDATE sessions SET creation_time={ts '"</span> &lt;&lt; sqlTime &lt;&lt; <span class="stringliteral">"'}, "</span>
00343   &lt;&lt; <span class="stringliteral">"incoming_seqnum="</span> &lt;&lt; m_cache.getNextTargetMsgSeqNum() &lt;&lt; <span class="stringliteral">", "</span>
00344   &lt;&lt; <span class="stringliteral">"outgoing_seqnum="</span> &lt;&lt; m_cache.getNextSenderMsgSeqNum() &lt;&lt; <span class="stringliteral">" WHERE "</span>
00345   &lt;&lt; <span class="stringliteral">"beginstring="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getBeginString().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00346   &lt;&lt; <span class="stringliteral">"sendercompid="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSenderCompID().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00347   &lt;&lt; <span class="stringliteral">"targetcompid="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getTargetCompID().getValue() &lt;&lt; <span class="stringliteral">"' and "</span>
00348   &lt;&lt; <span class="stringliteral">"session_qualifier="</span> &lt;&lt; <span class="stringliteral">"'"</span> &lt;&lt; m_sessionID.getSessionQualifier() &lt;&lt; <span class="stringliteral">"'"</span>;
00349 
00350   OdbcQuery query2( queryString2.str() );
00351   <span class="keywordflow">if</span>( !m_pConnection-&gt;execute(query2) )
00352     query2.throwException();
00353 
00354   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00355 }
00356 
00357 <span class="keywordtype">void</span> OdbcStore::refresh() <span class="keywordflow">throw</span> ( IOException )
00358 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(OdbcStore::refresh)
00359 
00360   m_cache.reset();
00361   populateCache(); 
00362 
00363   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00364 }
00365 
00366 }
00367 
00368 <span class="preprocessor">#endif</span>
</pre></div><hr><address><small>
Generated on Thu Sep 14 08:52:36 2006 for QuickFIX by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.6-20040222 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
