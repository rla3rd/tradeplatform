<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/home/orenmnero/autobuild/quickfix/src/C++/SocketMonitor.cpp Source File</title>
<link href="quickfix.css" rel="stylesheet" type="text/css">
<table cellspacing="0" cellpadding="0" border="0">
  <tr>
   <td><img src="images/outsideTopLeft.gif"></td>
   <td width="100%" class="outsideTop">&nbsp;</td>
   <td><img src="images/outsideTopRight.gif"></td>
  </tr>
  <tr>
   <td class="outsideLeft">&nbsp;</td>
   <td>
	<img src="images/QuickFIX.jpg" align="middle" border=0>
	&nbsp;&nbsp;
	<a href="index.html">Index</a>&nbsp;
	<a href="files.html">Source Files</a>&nbsp;
	<a href="annotated.html">Annotated Class List</a>&nbsp;
	<a href="classes.html">Alphabetical Class List</a>&nbsp;
	<a href="hierarchy.html">Class Hierarchy</a>&nbsp;
	<a href="inherits.html">Graphical Class Hierarchy</a>&nbsp;
   </td>
   <td class="outsideRight">&nbsp;</td>
  </tr>
  <tr>
   <td><img src="images/outsideBottomLeft.gif"></td>
   <td width=100% class="outsideBottom">&nbsp;</td>
   <td><img src="images/outsideBottomRight.gif"></td>
  </tr>
</table>
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.3.6-20040222 -->
<h1>/home/orenmnero/autobuild/quickfix/src/C++/SocketMonitor.cpp</h1><a href="_socket_monitor_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">** Copyright (c) quickfixengine.org  All rights reserved.</span>
00003 <span class="comment">**</span>
00004 <span class="comment">** This file is part of the QuickFIX FIX Engine</span>
00005 <span class="comment">**</span>
00006 <span class="comment">** This file may be distributed under the terms of the quickfixengine.org</span>
00007 <span class="comment">** license as defined by quickfixengine.org and appearing in the file</span>
00008 <span class="comment">** LICENSE included in the packaging of this file.</span>
00009 <span class="comment">**</span>
00010 <span class="comment">** This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE</span>
00011 <span class="comment">** WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
00012 <span class="comment">**</span>
00013 <span class="comment">** See http://www.quickfixengine.org/LICENSE for licensing information.</span>
00014 <span class="comment">**</span>
00015 <span class="comment">** Contact ask@quickfixengine.org if any conditions of this licensing are</span>
00016 <span class="comment">** not clear to you.</span>
00017 <span class="comment">**</span>
00018 <span class="comment">****************************************************************************/</span>
00019 
00020 <span class="preprocessor">#ifdef _MSC_VER</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#include "stdafx.h"</span>
00022 <span class="preprocessor">#else</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00024 <span class="preprocessor">#endif</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="_call_stack_8h.html">CallStack.h</a>"</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="_socket_monitor_8h.html">SocketMonitor.h</a>"</span>
00028 <span class="preprocessor">#include "<a class="code" href="_utility_8h.html">Utility.h</a>"</span>
00029 <span class="preprocessor">#include &lt;exception&gt;</span>
00030 <span class="preprocessor">#include &lt;set&gt;</span>
00031 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00032 <span class="preprocessor">#include &lt;iostream&gt;</span>
00033 
00034 <span class="keyword">namespace </span>FIX
00035 {
<a name="l00036"></a><a class="code" href="class_f_i_x_1_1_socket_monitor.html#a0">00036</a> SocketMonitor::SocketMonitor( <span class="keywordtype">int</span> timeout )
00037 : m_timeout( timeout )
00038 {
00039   <a class="code" href="namespace_f_i_x.html#a2913">socket_init</a>();
00040 
00041   std::pair&lt;int, int&gt; sockets = <a class="code" href="namespace_f_i_x.html#a2936">socket_createpair</a>();
00042   <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r3">m_signal</a> = sockets.first;
00043   <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r4">m_interrupt</a> = sockets.second;
00044   <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r6">m_readSockets</a>.insert( <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r4">m_interrupt</a> );
00045 
00046   <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r1">m_timeval</a>.tv_sec = 0;
00047   <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r1">m_timeval</a>.tv_usec = 0;
00048 <span class="preprocessor">#ifndef SELECT_DECREMENTS_TIME</span>
00049 <span class="preprocessor"></span>  <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r2">m_ticks</a> = clock();
00050 <span class="preprocessor">#endif</span>
00051 <span class="preprocessor"></span>}
00052 
<a name="l00053"></a><a class="code" href="class_f_i_x_1_1_socket_monitor.html#a1">00053</a> SocketMonitor::~SocketMonitor()
00054 {
00055   Sockets::iterator i;
00056   <span class="keywordflow">for</span> ( i = <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r6">m_readSockets</a>.begin(); i != <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r6">m_readSockets</a>.end(); ++i )
00057     <a class="code" href="namespace_f_i_x.html#a2920">socket_close</a>( *i );
00058   <a class="code" href="namespace_f_i_x.html#a2920">socket_close</a>( <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r3">m_signal</a> );
00059   <a class="code" href="namespace_f_i_x.html#a2920">socket_close</a>( <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r4">m_interrupt</a> );
00060   <a class="code" href="namespace_f_i_x.html#a2914">socket_term</a>();
00061 }
00062 
<a name="l00063"></a><a class="code" href="class_f_i_x_1_1_socket_monitor.html#a2">00063</a> <span class="keywordtype">bool</span> SocketMonitor::addConnect( <span class="keywordtype">int</span> s )
00064 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketMonitor::addConnect)
00065 
00066   <a class="code" href="namespace_f_i_x.html#a2928">socket_setnonblock</a>( s );
00067   Sockets::iterator i = <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r5">m_connectSockets</a>.find( s );
00068   <span class="keywordflow">if</span>( i != <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r5">m_connectSockets</a>.end() ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00069 
00070   <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r5">m_connectSockets</a>.insert( s );
00071   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00072 
00073   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00074 }
00075 
<a name="l00076"></a><a class="code" href="class_f_i_x_1_1_socket_monitor.html#a3">00076</a> <span class="keywordtype">bool</span> SocketMonitor::addRead( <span class="keywordtype">int</span> s )
00077 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketMonitor::addRead)
00078 
00079   <a class="code" href="namespace_f_i_x.html#a2928">socket_setnonblock</a>( s );
00080   Sockets::iterator i = <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r6">m_readSockets</a>.find( s );
00081   <span class="keywordflow">if</span>( i != <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r6">m_readSockets</a>.end() ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00082 
00083   <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r6">m_readSockets</a>.insert( s );
00084   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00085 
00086   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00087 }
00088 
<a name="l00089"></a><a class="code" href="class_f_i_x_1_1_socket_monitor.html#a4">00089</a> <span class="keywordtype">bool</span> SocketMonitor::addWrite( <span class="keywordtype">int</span> s )
00090 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketMonitor::addWrite)
00091 
00092   <span class="keywordflow">if</span>( <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r6">m_readSockets</a>.find(s) == <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r6">m_readSockets</a>.end() )
00093     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00094 
00095   <a class="code" href="namespace_f_i_x.html#a2928">socket_setnonblock</a>( s );
00096   Sockets::iterator i = <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r7">m_writeSockets</a>.find( s );
00097   <span class="keywordflow">if</span>( i != <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r7">m_writeSockets</a>.end() ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00098 
00099   <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r7">m_writeSockets</a>.insert( s );
00100   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00101 
00102   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00103 }
00104 
<a name="l00105"></a><a class="code" href="class_f_i_x_1_1_socket_monitor.html#a5">00105</a> <span class="keywordtype">bool</span> SocketMonitor::drop( <span class="keywordtype">int</span> s )
00106 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketMonitor::drop)
00107 
00108   Sockets::iterator i = <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r6">m_readSockets</a>.find( s );
00109   Sockets::iterator j = <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r7">m_writeSockets</a>.find( s );
00110   Sockets::iterator k = <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r5">m_connectSockets</a>.find( s );
00111 
00112   <span class="keywordflow">if</span> ( i != <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r6">m_readSockets</a>.end() || 
00113        j != <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r7">m_writeSockets</a>.end() ||
00114        k != <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r5">m_connectSockets</a>.end() )
00115   {
00116     <a class="code" href="namespace_f_i_x.html#a2920">socket_close</a>( s );
00117     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r6">m_readSockets</a>.erase( s );
00118     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r7">m_writeSockets</a>.erase( s );
00119     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r5">m_connectSockets</a>.erase( s );
00120     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r8">m_dropped</a>.<a class="code" href="class_f_i_x_1_1_queue.html#a0">push</a>( s );
00121     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00122   }
00123   <span class="keywordflow">return</span> <span class="keyword">false</span>;
00124 
00125   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00126 }
00127 
<a name="l00128"></a><a class="code" href="class_f_i_x_1_1_socket_monitor.html#d4">00128</a> <span class="keyword">inline</span> timeval* SocketMonitor::getTimeval( <span class="keywordtype">bool</span> poll )
00129 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketMonitor::getTimeval)
00130 
00131   <span class="keywordflow">if</span> ( poll )
00132   {
00133     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r1">m_timeval</a>.tv_sec = 0;
00134     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r1">m_timeval</a>.tv_usec = 0;
00135     <span class="keywordflow">return</span> &amp;<a class="code" href="class_f_i_x_1_1_socket_monitor.html#r1">m_timeval</a>;
00136   }
00137 
00138   <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_socket_monitor.html#r0">m_timeout</a> )
00139     <span class="keywordflow">return</span> 0;
00140 <span class="preprocessor">#ifdef SELECT_MODIFIES_TIMEVAL</span>
00141 <span class="preprocessor"></span>  <span class="keywordflow">if</span> ( !<a class="code" href="class_f_i_x_1_1_socket_monitor.html#r1">m_timeval</a>.tv_sec &amp;&amp; !<a class="code" href="class_f_i_x_1_1_socket_monitor.html#r1">m_timeval</a>.tv_usec &amp;&amp; <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r0">m_timeout</a> )
00142     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r1">m_timeval</a>.tv_sec = <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r0">m_timeout</a>;
00143   <span class="keywordflow">return</span> &amp;<a class="code" href="class_f_i_x_1_1_socket_monitor.html#r1">m_timeval</a>;
00144 <span class="preprocessor">#else</span>
00145 <span class="preprocessor"></span><span class="keywordtype">double</span> elapsed = ( <span class="keywordtype">double</span> ) ( clock() - <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r2">m_ticks</a> ) / ( <span class="keywordtype">double</span> ) CLOCKS_PER_SEC;
00146   <span class="keywordflow">if</span> ( elapsed &gt;= <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r0">m_timeout</a> || elapsed == 0.0 )
00147   {
00148     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r2">m_ticks</a> = clock();
00149     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r1">m_timeval</a>.tv_sec = 0;
00150     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r1">m_timeval</a>.tv_usec = <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r0">m_timeout</a> * 1000000;
00151   }
00152   <span class="keywordflow">else</span>
00153   {
00154     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r1">m_timeval</a>.tv_sec = 0;
00155     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r1">m_timeval</a>.tv_usec = ( <span class="keywordtype">long</span> ) ( ( <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r0">m_timeout</a> - elapsed ) * 1000000 );
00156   }
00157   <span class="keywordflow">return</span> &amp;<a class="code" href="class_f_i_x_1_1_socket_monitor.html#r1">m_timeval</a>;
00158 <span class="preprocessor">#endif</span>
00159 <span class="preprocessor"></span>
00160   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00161 }
00162 
<a name="l00163"></a><a class="code" href="class_f_i_x_1_1_socket_monitor.html#d5">00163</a> <span class="keywordtype">bool</span> SocketMonitor::sleepIfEmpty( <span class="keywordtype">bool</span> poll )
00164 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketMonitor::sleepIfEmpty)
00165 
00166   <span class="keywordflow">if</span>( poll )
00167     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00168 
00169   <span class="keywordflow">if</span> ( <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r6">m_readSockets</a>.empty() &amp;&amp; 
00170        <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r7">m_writeSockets</a>.empty() &amp;&amp;
00171        <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r5">m_connectSockets</a>.empty() )
00172   {
00173     <a class="code" href="namespace_f_i_x.html#a2944">process_sleep</a>( <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r0">m_timeout</a> );
00174     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00175   }
00176   <span class="keywordflow">else</span>
00177     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00178 
00179   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00180 }
00181 
<a name="l00182"></a><a class="code" href="class_f_i_x_1_1_socket_monitor.html#a6">00182</a> <span class="keywordtype">void</span> SocketMonitor::signal( <span class="keywordtype">int</span> socket )
00183 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketMonitor::signal)
00184   <a class="code" href="namespace_f_i_x.html#a2919">socket_send</a>( <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r3">m_signal</a>, (<span class="keywordtype">char</span>*)&amp;socket, <span class="keyword">sizeof</span>(socket) );
00185   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00186 }
00187 
<a name="l00188"></a><a class="code" href="class_f_i_x_1_1_socket_monitor.html#a7">00188</a> <span class="keywordtype">void</span> SocketMonitor::unsignal( <span class="keywordtype">int</span> s )
00189 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketMonitor::unsignal)
00190 
00191   Sockets::iterator i = <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r7">m_writeSockets</a>.find( s );
00192   <span class="keywordflow">if</span>( i == <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r7">m_writeSockets</a>.end() ) <span class="keywordflow">return</span>;
00193 
00194   <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r7">m_writeSockets</a>.erase( s );
00195 
00196   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00197 }
00198 
<a name="l00199"></a><a class="code" href="class_f_i_x_1_1_socket_monitor.html#a8">00199</a> <span class="keywordtype">void</span> SocketMonitor::block( <a class="code" href="class_f_i_x_1_1_socket_monitor_1_1_strategy.html">Strategy</a>&amp; strategy, <span class="keywordtype">bool</span> poll )
00200 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketMonitor::block)
00201 
00202   <span class="keywordflow">while</span> ( <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r8">m_dropped</a>.<a class="code" href="class_f_i_x_1_1_queue.html#a2">size</a>() )
00203   {
00204     strategy.<a class="code" href="class_f_i_x_1_1_socket_monitor_1_1_strategy.html#a4">onError</a>( *<span class="keyword">this</span>, <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r8">m_dropped</a>.front() );
00205     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r8">m_dropped</a>.<a class="code" href="class_f_i_x_1_1_queue.html#a1">pop</a>();
00206     <span class="keywordflow">if</span> ( <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r8">m_dropped</a>.<a class="code" href="class_f_i_x_1_1_queue.html#a2">size</a>() == 0 )
00207       <span class="keywordflow">return</span> ;
00208   }
00209 
00210   fd_set readSet;
00211   FD_ZERO( &amp;readSet );
00212   <a class="code" href="class_f_i_x_1_1_socket_monitor.html#d3">buildSet</a>( <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r6">m_readSockets</a>, readSet );
00213   fd_set writeSet;
00214   FD_ZERO( &amp;writeSet );
00215   <a class="code" href="class_f_i_x_1_1_socket_monitor.html#d3">buildSet</a>( <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r5">m_connectSockets</a>, writeSet );
00216   <a class="code" href="class_f_i_x_1_1_socket_monitor.html#d3">buildSet</a>( <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r7">m_writeSockets</a>, writeSet );
00217   fd_set exceptSet;
00218   FD_ZERO( &amp;exceptSet );
00219   <a class="code" href="class_f_i_x_1_1_socket_monitor.html#d3">buildSet</a>( <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r5">m_connectSockets</a>, exceptSet );
00220 
00221   <span class="keywordflow">if</span> ( <a class="code" href="class_f_i_x_1_1_socket_monitor.html#d5">sleepIfEmpty</a>(poll) )
00222   {
00223     strategy.<a class="code" href="class_f_i_x_1_1_socket_monitor_1_1_strategy.html#a6">onTimeout</a>( *<span class="keyword">this</span> );
00224     <span class="keywordflow">return</span>;
00225   }
00226 
00227   <span class="keywordtype">int</span> result = select( FD_SETSIZE, &amp;readSet, &amp;writeSet, &amp;exceptSet, <a class="code" href="class_f_i_x_1_1_socket_monitor.html#d4">getTimeval</a>(poll) );
00228 
00229   <span class="keywordflow">if</span> ( result == 0 )
00230   {
00231     strategy.<a class="code" href="class_f_i_x_1_1_socket_monitor_1_1_strategy.html#a6">onTimeout</a>( *<span class="keyword">this</span> );
00232     <span class="keywordflow">return</span>;
00233   }
00234   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( result &gt; 0 )
00235   {
00236     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#d8">processExceptSet</a>( strategy, exceptSet );
00237     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#d7">processWriteSet</a>( strategy, writeSet );
00238     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#d6">processReadSet</a>( strategy, readSet );
00239   }
00240   <span class="keywordflow">else</span>
00241   {
00242     strategy.<a class="code" href="class_f_i_x_1_1_socket_monitor_1_1_strategy.html#a4">onError</a>( *<span class="keyword">this</span> );
00243   }
00244 
00245   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00246 }
00247 
<a name="l00248"></a><a class="code" href="class_f_i_x_1_1_socket_monitor.html#d6">00248</a> <span class="keywordtype">void</span> SocketMonitor::processReadSet( <a class="code" href="class_f_i_x_1_1_socket_monitor_1_1_strategy.html">Strategy</a>&amp; strategy, fd_set&amp; readSet )
00249 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketMonitor::processReadSet)
00250 
00251 #ifdef _MSC_VER
00252   <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> i = 0; i &lt; readSet.fd_count; ++i )
00253   {
00254     <span class="keywordtype">int</span> s = readSet.fd_array[ i ];
00255     <span class="keywordflow">if</span>( s == <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r4">m_interrupt</a> )
00256     {
00257       <span class="keywordtype">int</span> socket = 0;
00258       recv( s, (<span class="keywordtype">char</span>*)&amp;socket, <span class="keyword">sizeof</span>(socket), 0 );
00259       <a class="code" href="class_f_i_x_1_1_socket_monitor.html#a4">addWrite</a>( socket );
00260     }
00261     <span class="keywordflow">else</span>
00262     {
00263       strategy.<a class="code" href="class_f_i_x_1_1_socket_monitor_1_1_strategy.html#a2">onEvent</a>( *<span class="keyword">this</span>, s );
00264     }
00265   }
00266 <span class="preprocessor">#else</span>
00267 <span class="preprocessor"></span>    Sockets::iterator i;
00268     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#y0">Sockets</a> sockets = <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r6">m_readSockets</a>;
00269     <span class="keywordflow">for</span> ( i = sockets.begin(); i != sockets.end(); ++i )
00270     {
00271       <span class="keywordtype">int</span> s = *i;
00272       <span class="keywordflow">if</span> ( !FD_ISSET( *i, &amp;readSet ) )
00273         <span class="keywordflow">continue</span>;
00274       <span class="keywordflow">if</span>( s == <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r4">m_interrupt</a> )
00275       {
00276         <span class="keywordtype">int</span> socket = 0;
00277         recv( s, (<span class="keywordtype">char</span>*)&amp;socket, <span class="keyword">sizeof</span>(socket), 0 );
00278         <a class="code" href="class_f_i_x_1_1_socket_monitor.html#a4">addWrite</a>( socket );
00279       }
00280       <span class="keywordflow">else</span>
00281       {
00282         strategy.<a class="code" href="class_f_i_x_1_1_socket_monitor_1_1_strategy.html#a2">onEvent</a>( *<span class="keyword">this</span>, s );
00283       }
00284     }
00285 <span class="preprocessor">#endif</span>
00286 <span class="preprocessor"></span>
00287   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00288 }
00289 
<a name="l00290"></a><a class="code" href="class_f_i_x_1_1_socket_monitor.html#d7">00290</a> <span class="keywordtype">void</span> SocketMonitor::processWriteSet( <a class="code" href="class_f_i_x_1_1_socket_monitor_1_1_strategy.html">Strategy</a>&amp; strategy, fd_set&amp; writeSet )
00291 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketMonitor::processWriteSet)
00292 
00293 #ifdef _MSC_VER
00294   <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> i = 0; i &lt; writeSet.fd_count; ++i )
00295   {
00296     <span class="keywordtype">int</span> s = writeSet.fd_array[ i ];
00297     <span class="keywordflow">if</span>( <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r5">m_connectSockets</a>.find(s) != <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r5">m_connectSockets</a>.end() )
00298     {
00299       <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r5">m_connectSockets</a>.erase( s );
00300       <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r6">m_readSockets</a>.insert( s );
00301       strategy.<a class="code" href="class_f_i_x_1_1_socket_monitor_1_1_strategy.html#a1">onConnect</a>( *<span class="keyword">this</span>, s );
00302     }
00303     <span class="keywordflow">else</span>
00304     {
00305       strategy.<a class="code" href="class_f_i_x_1_1_socket_monitor_1_1_strategy.html#a3">onWrite</a>( *<span class="keyword">this</span>, s );
00306     }
00307   }
00308 <span class="preprocessor">#else</span>
00309 <span class="preprocessor"></span>  Sockets::iterator i;
00310   <a class="code" href="class_f_i_x_1_1_socket_monitor.html#y0">Sockets</a> sockets = <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r5">m_connectSockets</a>;
00311   <span class="keywordflow">for</span>( i = sockets.begin(); i != sockets.end(); ++i )
00312   {
00313     <span class="keywordtype">int</span> s = *i;
00314     <span class="keywordflow">if</span> ( !FD_ISSET( *i, &amp;writeSet ) )
00315       <span class="keywordflow">continue</span>;
00316     m_connectSockets.erase( s );
00317     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r6">m_readSockets</a>.insert( s );
00318     strategy.<a class="code" href="class_f_i_x_1_1_socket_monitor_1_1_strategy.html#a1">onConnect</a>( *<span class="keyword">this</span>, s );
00319   }
00320 
00321   sockets = <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r7">m_writeSockets</a>;
00322   <span class="keywordflow">for</span>( i = sockets.begin(); i != sockets.end(); ++i )
00323   {
00324     <span class="keywordtype">int</span> s = *i;
00325     <span class="keywordflow">if</span> ( !FD_ISSET( *i, &amp;writeSet ) )
00326       <span class="keywordflow">continue</span>;
00327     strategy.<a class="code" href="class_f_i_x_1_1_socket_monitor_1_1_strategy.html#a3">onWrite</a>( *<span class="keyword">this</span>, s );
00328   }
00329 <span class="preprocessor">#endif</span>
00330 <span class="preprocessor"></span>
00331   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00332 }
00333 
<a name="l00334"></a><a class="code" href="class_f_i_x_1_1_socket_monitor.html#d8">00334</a> <span class="keywordtype">void</span> SocketMonitor::processExceptSet( <a class="code" href="class_f_i_x_1_1_socket_monitor_1_1_strategy.html">Strategy</a>&amp; strategy, fd_set&amp; exceptSet )
00335 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketMonitor::processExceptSet)
00336 
00337 #ifdef _MSC_VER
00338   <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> i = 0; i &lt; exceptSet.fd_count; ++i )
00339   {
00340     <span class="keywordtype">int</span> s = exceptSet.fd_array[ i ];
00341     strategy.<a class="code" href="class_f_i_x_1_1_socket_monitor_1_1_strategy.html#a4">onError</a>( *<span class="keyword">this</span>, s );
00342   }
00343 <span class="preprocessor">#else</span>
00344 <span class="preprocessor"></span>    Sockets::iterator i;
00345     <a class="code" href="class_f_i_x_1_1_socket_monitor.html#y0">Sockets</a> sockets = <a class="code" href="class_f_i_x_1_1_socket_monitor.html#r5">m_connectSockets</a>;
00346     <span class="keywordflow">for</span> ( i = sockets.begin(); i != sockets.end(); ++i )
00347     {
00348       <span class="keywordtype">int</span> s = *i;
00349       <span class="keywordflow">if</span> ( !FD_ISSET( *i, &amp;exceptSet ) )
00350         <span class="keywordflow">continue</span>;
00351       strategy.<a class="code" href="class_f_i_x_1_1_socket_monitor_1_1_strategy.html#a4">onError</a>( *<span class="keyword">this</span>, s );
00352     }
00353 <span class="preprocessor">#endif</span>
00354 <span class="preprocessor"></span>
00355   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00356 }
00357 
<a name="l00358"></a><a class="code" href="class_f_i_x_1_1_socket_monitor.html#d3">00358</a> <span class="keywordtype">void</span> SocketMonitor::buildSet( <span class="keyword">const</span> <a class="code" href="class_f_i_x_1_1_socket_monitor.html#y0">Sockets</a>&amp; sockets, fd_set&amp; watchSet )
00359 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(SocketMonitor::buildSet)
00360 
00361   Sockets::const_iterator iter;
00362   <span class="keywordflow">for</span> ( iter = sockets.begin(); iter != sockets.end(); ++iter ) {
00363     FD_SET( *iter, &amp;watchSet );
00364   }
00365   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00366 }
00367 }
</pre></div><hr><address><small>
Generated on Thu Sep 14 08:52:37 2006 for QuickFIX by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.6-20040222 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
