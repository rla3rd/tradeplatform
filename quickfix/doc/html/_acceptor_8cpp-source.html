<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>/home/orenmnero/autobuild/quickfix/src/C++/Acceptor.cpp Source File</title>
<link href="quickfix.css" rel="stylesheet" type="text/css">
<table cellspacing="0" cellpadding="0" border="0">
  <tr>
   <td><img src="images/outsideTopLeft.gif"></td>
   <td width="100%" class="outsideTop">&nbsp;</td>
   <td><img src="images/outsideTopRight.gif"></td>
  </tr>
  <tr>
   <td class="outsideLeft">&nbsp;</td>
   <td>
	<img src="images/QuickFIX.jpg" align="middle" border=0>
	&nbsp;&nbsp;
	<a href="index.html">Index</a>&nbsp;
	<a href="files.html">Source Files</a>&nbsp;
	<a href="annotated.html">Annotated Class List</a>&nbsp;
	<a href="classes.html">Alphabetical Class List</a>&nbsp;
	<a href="hierarchy.html">Class Hierarchy</a>&nbsp;
	<a href="inherits.html">Graphical Class Hierarchy</a>&nbsp;
   </td>
   <td class="outsideRight">&nbsp;</td>
  </tr>
  <tr>
   <td><img src="images/outsideBottomLeft.gif"></td>
   <td width=100% class="outsideBottom">&nbsp;</td>
   <td><img src="images/outsideBottomRight.gif"></td>
  </tr>
</table>
</head><body bgcolor="#ffffff">
<!-- Generated by Doxygen 1.3.6-20040222 -->
<h1>/home/orenmnero/autobuild/quickfix/src/C++/Acceptor.cpp</h1><a href="_acceptor_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/****************************************************************************</span>
00002 <span class="comment">** Copyright (c) quickfixengine.org  All rights reserved.</span>
00003 <span class="comment">**</span>
00004 <span class="comment">** This file is part of the QuickFIX FIX Engine</span>
00005 <span class="comment">**</span>
00006 <span class="comment">** This file may be distributed under the terms of the quickfixengine.org</span>
00007 <span class="comment">** license as defined by quickfixengine.org and appearing in the file</span>
00008 <span class="comment">** LICENSE included in the packaging of this file.</span>
00009 <span class="comment">**</span>
00010 <span class="comment">** This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE</span>
00011 <span class="comment">** WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
00012 <span class="comment">**</span>
00013 <span class="comment">** See http://www.quickfixengine.org/LICENSE for licensing information.</span>
00014 <span class="comment">**</span>
00015 <span class="comment">** Contact ask@quickfixengine.org if any conditions of this licensing are</span>
00016 <span class="comment">** not clear to you.</span>
00017 <span class="comment">**</span>
00018 <span class="comment">****************************************************************************/</span>
00019 
00020 <span class="preprocessor">#ifdef _MSC_VER</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#include "stdafx.h"</span>
00022 <span class="preprocessor">#else</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#include "config.h"</span>
00024 <span class="preprocessor">#endif</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="_call_stack_8h.html">CallStack.h</a>"</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="_acceptor_8h.html">Acceptor.h</a>"</span>
00028 <span class="preprocessor">#include "<a class="code" href="_utility_8h.html">Utility.h</a>"</span>
00029 <span class="preprocessor">#include "<a class="code" href="_session_8h.html">Session.h</a>"</span>
00030 <span class="preprocessor">#include "<a class="code" href="_session_factory_8h.html">SessionFactory.h</a>"</span>
00031 <span class="preprocessor">#include "<a class="code" href="_http_server_8h.html">HttpServer.h</a>"</span>
00032 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00033 <span class="preprocessor">#include &lt;fstream&gt;</span>
00034 
<a name="l00035"></a><a class="code" href="namespace_f_i_x.html">00035</a> <span class="keyword">namespace </span>FIX
00036 {
<a name="l00037"></a><a class="code" href="class_f_i_x_1_1_acceptor.html#a0">00037</a> Acceptor::Acceptor( <a class="code" href="class_f_i_x_1_1_application.html">Application</a>&amp; application,
00038                     <a class="code" href="class_f_i_x_1_1_message_store_factory.html">MessageStoreFactory</a>&amp; messageStoreFactory,
00039                     <span class="keyword">const</span> <a class="code" href="class_f_i_x_1_1_session_settings.html">SessionSettings</a>&amp; settings )
00040 <span class="keywordflow">throw</span>( <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a> )
00041   : m_threadid( 0 ),
00042   m_application( application ),
00043   m_messageStoreFactory( messageStoreFactory ),
00044   m_settings( settings ),
00045   m_pLogFactory( 0 ),
00046   m_pLog( 0 ),
00047   m_firstPoll( <span class="keyword">true</span> ),
00048   m_stop( <span class="keyword">false</span> )
00049 {
00050   initialize();
00051 }
00052 
<a name="l00053"></a><a class="code" href="class_f_i_x_1_1_acceptor.html#a1">00053</a> Acceptor::Acceptor( <a class="code" href="class_f_i_x_1_1_application.html">Application</a>&amp; application,
00054                     <a class="code" href="class_f_i_x_1_1_message_store_factory.html">MessageStoreFactory</a>&amp; messageStoreFactory,
00055                     <span class="keyword">const</span> <a class="code" href="class_f_i_x_1_1_session_settings.html">SessionSettings</a>&amp; settings,
00056                     <a class="code" href="class_f_i_x_1_1_log_factory.html">LogFactory</a>&amp; logFactory )
00057 <span class="keywordflow">throw</span>( <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a> )
00058 : m_threadid( 0 ),
00059   m_application( application ),
00060   m_messageStoreFactory( messageStoreFactory ),
00061   m_settings( settings ),
00062   m_pLogFactory( &amp;logFactory ),
00063   m_pLog( logFactory.create() ),
00064   m_firstPoll( <span class="keyword">true</span> ),
00065   m_stop( <span class="keyword">false</span> )
00066 {
00067   initialize();
00068 }
00069 
<a name="l00070"></a><a class="code" href="class_f_i_x_1_1_acceptor.html#d0">00070</a> <span class="keywordtype">void</span> Acceptor::initialize() <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a> )
00071 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>( Acceptor::initialize )
00072 
00073   std::set &lt; SessionID &gt; sessions = m_settings.getSessions();
00074   std::set &lt; SessionID &gt; ::iterator i;
00075 
00076   <span class="keywordflow">if</span> ( !sessions.size() )
00077     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a>( <span class="stringliteral">"No sessions defined"</span> );
00078 
00079   <a class="code" href="class_f_i_x_1_1_session_factory.html">SessionFactory</a> factory( m_application, m_messageStoreFactory,
00080                           m_pLogFactory );
00081 
00082   <span class="keywordflow">for</span> ( i = sessions.begin(); i != sessions.end(); ++i )
00083   {
00084     <span class="keywordflow">if</span> ( m_settings.get( *i ).getString( <a class="code" href="namespace_f_i_x.html#a161">CONNECTION_TYPE</a> ) == <span class="stringliteral">"acceptor"</span> )
00085     {
00086       m_sessionIDs.insert( *i );
00087       m_sessions[ *i ] = factory.<a class="code" href="class_f_i_x_1_1_session_factory.html#a2">create</a>( *i, m_settings.get( *i ) );
00088     }
00089   }
00090 
00091   <span class="keywordflow">if</span> ( !m_sessions.size() )
00092     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a>( <span class="stringliteral">"No sessions defined for acceptor"</span> );
00093 
00094   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00095 }
00096 
<a name="l00097"></a><a class="code" href="class_f_i_x_1_1_acceptor.html#a2">00097</a> Acceptor::~Acceptor()
00098 { <a class="code" href="_call_stack_8h.html#a2">QF_STACK_IGNORE_BEGIN</a>
00099 
00100   Sessions::iterator i;
00101   <span class="keywordflow">for</span> ( i = <a class="code" href="class_f_i_x_1_1_acceptor.html#r1">m_sessions</a>.begin(); i != <a class="code" href="class_f_i_x_1_1_acceptor.html#r1">m_sessions</a>.end(); ++i )
00102     <span class="keyword">delete</span> i-&gt;second;
00103 
00104   <span class="keywordflow">if</span>( <a class="code" href="class_f_i_x_1_1_acceptor.html#r6">m_pLogFactory</a> &amp;&amp; <a class="code" href="class_f_i_x_1_1_acceptor.html#r7">m_pLog</a> )
00105     <a class="code" href="class_f_i_x_1_1_acceptor.html#r6">m_pLogFactory</a>-&gt;<a class="code" href="class_f_i_x_1_1_log_factory.html#a3">destroy</a>( <a class="code" href="class_f_i_x_1_1_acceptor.html#r7">m_pLog</a> );
00106   
00107   <a class="code" href="_call_stack_8h.html#a3">QF_STACK_IGNORE_END</a>
00108 }
00109 
00110 <a class="code" href="class_f_i_x_1_1_session.html">Session</a>* Acceptor::getSession
<a name="l00111"></a><a class="code" href="class_f_i_x_1_1_acceptor.html#a8">00111</a> ( <span class="keyword">const</span> std::string&amp; msg, <a class="code" href="class_f_i_x_1_1_responder.html">Responder</a>&amp; responder )
00112 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>( Acceptor::getSession )
00113 
00114   <a class="code" href="class_f_i_x_1_1_message.html">Message</a> message;
00115   <span class="keywordflow">if</span> ( !message.<a class="code" href="class_f_i_x_1_1_message.html#a18">setStringHeader</a>( msg ) )
00116     <span class="keywordflow">return</span> 0;
00117 
00118   BeginString beginString;
00119   SenderCompID clSenderCompID;
00120   TargetCompID clTargetCompID;
00121   MsgType msgType;
00122   <span class="keywordflow">try</span>
00123   {
00124     message.<a class="code" href="class_f_i_x_1_1_message.html#a19">getHeader</a>().<a class="code" href="class_f_i_x_1_1_field_map.html#a7">getField</a>( beginString );
00125     message.<a class="code" href="class_f_i_x_1_1_message.html#a19">getHeader</a>().<a class="code" href="class_f_i_x_1_1_field_map.html#a7">getField</a>( clSenderCompID );
00126     message.<a class="code" href="class_f_i_x_1_1_message.html#a19">getHeader</a>().<a class="code" href="class_f_i_x_1_1_field_map.html#a7">getField</a>( clTargetCompID );
00127     message.<a class="code" href="class_f_i_x_1_1_message.html#a19">getHeader</a>().<a class="code" href="class_f_i_x_1_1_field_map.html#a7">getField</a>( msgType );
00128     <span class="keywordflow">if</span> ( msgType != <span class="stringliteral">"A"</span> ) <span class="keywordflow">return</span> 0;
00129 
00130     SenderCompID senderCompID( clTargetCompID );
00131     TargetCompID targetCompID( clSenderCompID );
00132     <a class="code" href="class_f_i_x_1_1_session_i_d.html">SessionID</a> sessionID( beginString, senderCompID, targetCompID );
00133 
00134     Sessions::iterator i = m_sessions.find( sessionID );
00135     <span class="keywordflow">if</span> ( i != m_sessions.end() )
00136     {
00137       i-&gt;second-&gt;setResponder( &amp;responder );
00138       <span class="keywordflow">return</span> i-&gt;second;
00139     }
00140   }
00141   <span class="keywordflow">catch</span> ( <a class="code" href="struct_f_i_x_1_1_field_not_found.html">FieldNotFound</a>&amp; ) {}
00142   <span class="keywordflow">return</span> 0;
00143 
00144   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00145 }
00146 
<a name="l00147"></a><a class="code" href="class_f_i_x_1_1_acceptor.html#a3">00147</a> <span class="keywordtype">void</span> Acceptor::start() <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a>, <a class="code" href="struct_f_i_x_1_1_runtime_error.html">RuntimeError</a> )
00148 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>( Acceptor::start )
00149 
00150   m_stop = <span class="keyword">false</span>;
00151   onConfigure( m_settings );
00152   onInitialize( m_settings );
00153 
00154   HttpServer::startGlobal( m_settings );
00155 
00156   <span class="keywordflow">if</span>( !<a class="code" href="namespace_f_i_x.html#a2939">thread_spawn</a>( &amp;startThread, <span class="keyword">this</span>, m_threadid ) )
00157     <span class="keywordflow">throw</span> <a class="code" href="struct_f_i_x_1_1_runtime_error.html">RuntimeError</a>(<span class="stringliteral">"Unable to spawn thread"</span>);
00158 
00159   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00160 }
00161 
<a name="l00162"></a><a class="code" href="class_f_i_x_1_1_acceptor.html#a4">00162</a> <span class="keywordtype">void</span> Acceptor::block() <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a>, <a class="code" href="struct_f_i_x_1_1_runtime_error.html">RuntimeError</a> )
00163 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>( Acceptor::start )
00164 
00165   onConfigure( m_settings );
00166   onInitialize( m_settings );
00167 
00168   startThread(<span class="keyword">this</span>);
00169 
00170   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00171 }
00172 
<a name="l00173"></a><a class="code" href="class_f_i_x_1_1_acceptor.html#a5">00173</a> <span class="keywordtype">bool</span> Acceptor::poll() <span class="keywordflow">throw</span> ( <a class="code" href="struct_f_i_x_1_1_config_error.html">ConfigError</a>, <a class="code" href="struct_f_i_x_1_1_runtime_error.html">RuntimeError</a> )
00174 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>( Acceptor::poll )
00175 
00176   <span class="keywordflow">if</span>( m_firstPoll )
00177   {
00178     onConfigure( m_settings );
00179     onInitialize( m_settings );
00180     m_firstPoll = <span class="keyword">false</span>;
00181   }
00182 
00183   <span class="keywordflow">return</span> onPoll();
00184 
00185   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00186 }
00187 
<a name="l00188"></a><a class="code" href="class_f_i_x_1_1_acceptor.html#a6">00188</a> <span class="keywordtype">void</span> Acceptor::stop( <span class="keywordtype">bool</span> force )
00189 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>( Acceptor::stop )
00190 
00191   <span class="keywordflow">if</span>( <a class="code" href="class_f_i_x_1_1_acceptor.html#a11">isStopped</a>() ) <span class="keywordflow">return</span>;
00192 
00193   HttpServer::stopGlobal();
00194 
00195   std::vector&lt;Session*&gt; enabledSessions;
00196 
00197   <a class="code" href="class_f_i_x_1_1_acceptor.html#y1">Sessions</a> sessions = <a class="code" href="class_f_i_x_1_1_acceptor.html#r1">m_sessions</a>;
00198   Sessions::iterator i = sessions.begin();
00199   <span class="keywordflow">for</span> ( ; i != sessions.end(); ++i )
00200   {
00201     <a class="code" href="class_f_i_x_1_1_session.html">Session</a>* pSession = Session::lookupSession(i-&gt;first);
00202     <span class="keywordflow">if</span>( pSession-&gt;<a class="code" href="class_f_i_x_1_1_session.html#a4">isEnabled</a>() )
00203     {
00204       enabledSessions.push_back( pSession );
00205       pSession-&gt;<a class="code" href="class_f_i_x_1_1_session.html#a3">logout</a>();
00206       Session::unregisterSession( pSession-&gt;<a class="code" href="class_f_i_x_1_1_session.html#a13">getSessionID</a>() );
00207     }
00208   }
00209 
00210   <span class="keywordflow">if</span>( !force )
00211   {
00212     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> second = 1; second &lt;= 10 &amp;&amp; <a class="code" href="class_f_i_x_1_1_acceptor.html#a7">isLoggedOn</a>(); ++second )
00213       <a class="code" href="namespace_f_i_x.html#a2944">process_sleep</a>( 1 );
00214   }
00215 
00216   <a class="code" href="class_f_i_x_1_1_acceptor.html#r9">m_stop</a> = <span class="keyword">true</span>;
00217   <a class="code" href="class_f_i_x_1_1_acceptor.html#d5">onStop</a>();
00218   <span class="keywordflow">if</span>( <a class="code" href="class_f_i_x_1_1_acceptor.html#r0">m_threadid</a> )
00219     <a class="code" href="namespace_f_i_x.html#a2941">thread_join</a>( <a class="code" href="class_f_i_x_1_1_acceptor.html#r0">m_threadid</a> );
00220   <a class="code" href="class_f_i_x_1_1_acceptor.html#r0">m_threadid</a> = 0;
00221 
00222   std::vector&lt;Session*&gt;::iterator session = enabledSessions.begin();
00223   <span class="keywordflow">for</span>( ; session != enabledSessions.end(); ++session )
00224     (*session)-&gt;logon();
00225 
00226   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00227 }
00228 
<a name="l00229"></a><a class="code" href="class_f_i_x_1_1_acceptor.html#a7">00229</a> <span class="keywordtype">bool</span> Acceptor::isLoggedOn()
00230 { <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>(Acceptor::isLoggedOn)
00231 
00232   <a class="code" href="class_f_i_x_1_1_acceptor.html#y1">Sessions</a> sessions = <a class="code" href="class_f_i_x_1_1_acceptor.html#r1">m_sessions</a>;
00233   Sessions::iterator i = sessions.begin();
00234   <span class="keywordflow">for</span> ( ; i != sessions.end(); ++i )
00235   {
00236     <span class="keywordflow">if</span>( i-&gt;second-&gt;isLoggedOn() )
00237       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00238   }
00239   <span class="keywordflow">return</span> <span class="keyword">false</span>;
00240 
00241   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00242 }
00243 
<a name="l00244"></a><a class="code" href="class_f_i_x_1_1_acceptor.html#h0">00244</a> <a class="code" href="_utility_8h.html#a1">THREAD_PROC</a> Acceptor::startThread( <span class="keywordtype">void</span>* p )
00245 { <a class="code" href="_call_stack_8h.html#a4">QF_STACK_TRY</a>
00246   <a class="code" href="_call_stack_8h.html#a0">QF_STACK_PUSH</a>( Acceptor::startThread )
00247 
00248   <a class="code" href="class_f_i_x_1_1_acceptor.html">Acceptor</a> * pAcceptor = static_cast &lt; Acceptor* &gt; ( p );
00249   pAcceptor-&gt;onStart();
00250   <span class="keywordflow">return</span> 0;
00251 
00252   <a class="code" href="_call_stack_8h.html#a1">QF_STACK_POP</a>
00253   <a class="code" href="_call_stack_8h.html#a5">QF_STACK_CATCH</a>
00254 }
00255 }
</pre></div><hr><address><small>
Generated on Thu Sep 14 08:52:33 2006 for QuickFIX by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.6-20040222 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2001</small></address>
</body>
</html>
